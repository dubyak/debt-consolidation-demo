<!DOCTYPE html>
<!--
    Debt Consolidation Demo - Clean Chat Agent Version
    ===================================================
    
    This version uses OpenAI API directly with a clean chat interface.
    The LLM handles the entire flow naturally through conversation.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tala - Debt Consolidation Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
        }
        .api-key-input {
            font-family: monospace;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 flex flex-col items-center justify-center p-4">
        <!-- Password Protection Modal -->
        <div id="passwordModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-teal-500 to-emerald-500 flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">üåø</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Tala Demo</h2>
                    <p class="text-sm text-gray-600">Enter your credentials to access</p>
                </div>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 block mb-1">Username</label>
                        <input
                            type="text"
                            id="usernameInput"
                            placeholder="Enter username"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                            autocomplete="username"
                        />
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 block mb-1">Password</label>
                        <input
                            type="password"
                            id="passwordInput"
                            placeholder="Enter password"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500"
                            autocomplete="current-password"
                        />
                    </div>
                    <div id="loginError" class="text-red-500 text-xs text-center hidden"></div>
                    <button
                        type="submit"
                        class="w-full px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white rounded-lg font-semibold transition-colors"
                    >
                        Access Demo
                    </button>
                </form>
            </div>
        </div>

        <!-- Phone Frame -->
        <div class="w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden border-8 border-gray-800 relative">
            <!-- Status Bar -->
            <div class="bg-gray-800 text-white px-6 py-2 flex justify-between items-center text-xs">
                <span>9:41</span>
                <div class="flex gap-1 items-center">
                    <div class="w-4 h-2 border border-white rounded-sm relative">
                        <div class="absolute inset-0.5 bg-white rounded-sm" style="width: 80%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Indicator -->
            <div id="progressIndicator" class="hidden bg-gray-100 px-4 py-2 border-b border-gray-200">
                <div class="flex items-center justify-between text-xs text-gray-600 mb-1">
                    <span id="progressStep">Step 1 of 4</span>
                    <span id="progressPercent">25%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-1.5">
                    <div id="progressBar" class="bg-teal-500 h-1.5 rounded-full transition-all duration-300" style="width: 25%"></div>
                </div>
            </div>

            <!-- Header -->
            <div class="bg-gradient-to-r from-teal-500 to-emerald-500 px-4 py-4 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                    <span class="text-xl">üåø</span>
                </div>
                <div class="flex-1">
                    <h1 id="title" class="text-white font-semibold text-lg tracking-tight">Tala</h1>
                    <p id="subtitle" class="text-teal-100 text-xs">Tu aliado financiero</p>
                </div>
                <div class="flex items-center gap-2">
                    <button 
                        id="langToggle"
                        class="px-2 py-1 bg-white/20 hover:bg-white/30 text-white text-xs font-semibold rounded-lg transition-colors"
                    >
                        EN
                    </button>
                    <button 
                        id="resetBtn"
                        class="text-white/70 hover:text-white text-xs underline"
                    >
                        Reiniciar
                    </button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesArea" class="h-96 overflow-y-auto p-4 space-y-3 bg-gray-50">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-100 bg-white p-3">
                <form id="messageForm" class="flex gap-2 items-end">
                    <button
                        type="button"
                        id="imageBtn"
                        class="w-10 h-10 rounded-full bg-teal-100 hover:bg-teal-200 flex items-center justify-center text-teal-600 transition-colors flex-shrink-0"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <input
                        type="file"
                        id="fileInput"
                        accept="image/*"
                        class="hidden"
                    />
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="Escribe un mensaje..."
                        class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-teal-300 transition-all"
                    />
                    <button
                        type="submit"
                        id="sendBtn"
                        class="w-10 h-10 rounded-full bg-teal-500 hover:bg-teal-600 disabled:bg-gray-300 flex items-center justify-center text-white transition-colors flex-shrink-0"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="mt-6 max-w-sm w-full bg-white/90 backdrop-blur rounded-xl p-4 shadow-lg">
            <h2 id="demoTitle" class="font-bold text-teal-800 mb-3 text-sm">üß™ Configuraci√≥n</h2>
            <div class="space-y-3">
                <div>
                    <label id="customerLabel" class="text-xs text-gray-500 block mb-1">Nombre del Cliente</label>
                    <input
                        type="text"
                        id="customerNameInput"
                        class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-300"
                    />
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label id="limitLabel" class="text-xs text-gray-500 block mb-1">L√≠mite Tala (MXN)</label>
                        <input
                            type="number"
                            id="currentLimitInput"
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-300"
                        />
                    </div>
                    <div>
                        <label id="rateLabel" class="text-xs text-gray-500 block mb-1">Tasa (%/semana)</label>
                        <input
                            type="number"
                            step="0.1"
                            id="currentRateInput"
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-300"
                        />
                    </div>
                    <div>
                        <label id="termLabel" class="text-xs text-gray-500 block mb-1">Plazo (meses)</label>
                        <input
                            type="number"
                            id="currentTermInput"
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-300"
                        />
                    </div>
                </div>
                <button
                    id="applyRestartBtn"
                    class="w-full px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white text-xs font-semibold rounded-lg transition-colors"
                >
                    Aplicar y Reiniciar
                </button>
            </div>
        </div>
    </div>

    <script>
        const UI_TEXT = {
            en: {
                title: 'Tala',
                subtitle: 'Your loan buddy',
                reset: 'Reset',
                typePlaceholder: 'Type a message...',
                demoTitle: 'üß™ Settings',
                customer: 'Customer Name',
                currentLimit: 'Tala Limit (MXN)',
                currentRate: 'Rate (%/week)',
                currentTerm: 'Term (months)',
                langToggle: 'ES',
                applyRestart: 'Apply & Restart',
                changeKey: 'Change'
            },
            es: {
                title: 'Tala',
                subtitle: 'Tu aliado financiero',
                reset: 'Reiniciar',
                typePlaceholder: 'Escribe un mensaje...',
                demoTitle: 'üß™ Configuraci√≥n',
                customer: 'Nombre del Cliente',
                currentLimit: 'L√≠mite Tala (MXN)',
                currentRate: 'Tasa (%/semana)',
                currentTerm: 'Plazo (meses)',
                langToggle: 'EN',
                applyRestart: 'Aplicar y Reiniciar',
                changeKey: 'Cambiar'
            }
        };

        // Customer profile defaults
        const DEFAULT_PROFILE = {
            customerName: 'Mar√≠a',
            currentLimit: 3000,
            currentRate: 4.5,
            currentTerm: 6
        };

        // Configuration - Railway backend URL
        const BACKEND_URL = 'https://debt-consolidation-demo-production.up.railway.app';
        
        // Demo credentials
        const DEMO_CREDENTIALS = {
            username: 'Talajote',
            password: 'StackWithT@la'
        };
        
        // State
        let messages = [];
        let language = 'es';
        let isLoading = false;
        let customerProfile = { ...DEFAULT_PROFILE };
        let isAuthenticated = false;
        let extractedLoans = []; // Store extracted loan data
        let pendingLoanConfirmation = null; // Loan waiting for user confirmation

        // No longer needed - backend handles API keys
        // Keeping for backward compatibility but will be removed

        // Calculation functions (deterministic, no LLM)
        function calculateWeightedAverageRate(loans) {
            if (!loans || loans.length === 0) return 0;
            let totalWeightedRate = 0;
            let totalBalance = 0;
            
            loans.forEach(loan => {
                const balance = parseFloat(loan.balance) || 0;
                const rate = parseFloat(loan.weeklyRate) || 0;
                totalWeightedRate += balance * rate;
                totalBalance += balance;
            });
            
            return totalBalance > 0 ? totalWeightedRate / totalBalance : 0;
        }

        function calculateTotalMonthlyPayment(loans) {
            return loans.reduce((sum, loan) => {
                return sum + (parseFloat(loan.monthlyPayment) || 0);
            }, 0);
        }

        function calculateWeeklyInterest(balance, weeklyRate) {
            return (parseFloat(balance) || 0) * (parseFloat(weeklyRate) || 0) / 100;
        }

        function calculateConsolidationOffer(loans, talaRate, talaLimit) {
            // Don't include Tala loan in consolidation - customers are in good standing
            // Only consolidate the other loans
            const loansToConsolidate = loans; // Just the extracted loans, not Tala
            
            const totalBalance = Math.min(
                loansToConsolidate.reduce((sum, loan) => sum + (parseFloat(loan.balance) || 0), 0),
                15000 // Max limit
            );
            
            const weightedRate = calculateWeightedAverageRate(loansToConsolidate);
            
            // Calculate current costs (other loans only, not Tala)
            const currentWeeklyInterest = loansToConsolidate.reduce((sum, loan) => {
                return sum + calculateWeeklyInterest(loan.balance, loan.weeklyRate);
            }, 0);
            
            let consolidationWeeklyRate = weightedRate;
            let newWeeklyInterest = calculateWeeklyInterest(totalBalance, consolidationWeeklyRate);
            let weeklySavings = currentWeeklyInterest - newWeeklyInterest;
            
            // Adjust rate downward if needed to meet minimum savings
            while (weeklySavings < 100 && consolidationWeeklyRate > 0) {
                consolidationWeeklyRate -= 0.1;
                newWeeklyInterest = calculateWeeklyInterest(totalBalance, consolidationWeeklyRate);
                weeklySavings = currentWeeklyInterest - newWeeklyInterest;
            }
            
            const currentMonthlyPayment = calculateTotalMonthlyPayment(loansToConsolidate);
            const newMonthlyPayment = totalBalance * (consolidationWeeklyRate / 100) * 4.33; // Approximate
            const monthlySavings = currentMonthlyPayment - newMonthlyPayment;
            
            // Calculate interest savings
            const currentMonthlyInterest = currentWeeklyInterest * 4.33;
            const newMonthlyInterest = newWeeklyInterest * 4.33;
            const monthlyInterestSavings = currentMonthlyInterest - newMonthlyInterest;
            const annualInterestSavings = weeklySavings * 52;
            
            return {
                totalBalance,
                consolidationRate: consolidationWeeklyRate,
                currentMonthlyPayment,
                newMonthlyPayment,
                monthlySavings,
                weeklySavings: Math.max(weeklySavings, 100),
                currentWeeklyInterest,
                newWeeklyInterest,
                monthlyInterestSavings: Math.max(monthlyInterestSavings, monthlySavings * 0.8), // Approximate
                annualInterestSavings: Math.max(annualInterestSavings, weeklySavings * 52),
                remainingCredit: Math.max(0, 15000 - totalBalance),
                loans: loansToConsolidate,
                loanCount: loansToConsolidate.length
            };
        }

        // Build system prompt with customer info
        function buildSystemPrompt(useStructuredExtraction = false) {
            const lang = language === 'es' ? 'ES' : 'EN';
            const customerInfo = language === 'es'
                ? `Nombre: ${customerProfile.customerName}, L√≠mite actual en Tala: $${customerProfile.currentLimit.toLocaleString()} MXN, Tasa Tala: ${customerProfile.currentRate}%/semana, Plazo: ${customerProfile.currentTerm} meses`
                : `Name: ${customerProfile.customerName}, Current Tala limit: $${customerProfile.currentLimit.toLocaleString()} MXN, Tala rate: ${customerProfile.currentRate}%/week, Term: ${customerProfile.currentTerm} months`;

            let basePrompt = language === 'es' ? SYSTEM_PROMPT_ES : SYSTEM_PROMPT_EN;
            
            if (useStructuredExtraction) {
                const extractionInstructions = language === 'es'
                    ? `\n\nEXTRACCI√ìN DE DATOS DEL PR√âSTAMO:\nCuando el cliente comparta una captura de pr√©stamo, DEBES responder SOLO con un JSON v√°lido en este formato exacto:\n{\n  "lender": "Nombre del prestamista",\n  "balance": n√∫mero (saldo pendiente en MXN),\n  "monthlyPayment": n√∫mero (pago mensual en MXN),\n  "paymentFrequency": "mensual" o "semanal",\n  "weeklyRate": n√∫mero (tasa semanal como porcentaje, ej: 7.5),\n  "monthlyRate": n√∫mero (tasa mensual como porcentaje, si est√° disponible)\n}\n\nNO incluyas texto adicional, solo el JSON.`
                    : `\n\nLOAN DATA EXTRACTION:\nWhen the customer shares a loan screenshot, you MUST respond ONLY with valid JSON in this exact format:\n{\n  "lender": "Lender name",\n  "balance": number (outstanding balance in MXN),\n  "monthlyPayment": number (monthly payment in MXN),\n  "paymentFrequency": "monthly" or "weekly",\n  "weeklyRate": number (weekly rate as percentage, e.g., 7.5),\n  "monthlyRate": number (monthly rate as percentage, if available)\n}\n\nDo NOT include any additional text, only the JSON.`;
                
                basePrompt += extractionInstructions;
            }
            
            return `${basePrompt}\n\nCUSTOMER PROFILE:\n${customerInfo}`;
        }

        const SYSTEM_PROMPT_EN = `You are Maya, a friendly loan advisor at Tala. You're warm, supportive, and genuinely want to help customers manage their finances better. Think of yourself as that helpful friend at a neighborhood credit cooperative - approachable, not corporate.

CONTEXT:
- The customer details will be provided (name, current Tala limit, current Tala rate, term)
- They have completed 5 loans successfully with Tala
- They have ALREADY OPTED IN to this special opportunity - they're interested and ready to proceed
- This is a debt consolidation product - ONE loan to replace all their other loans

CONSOLIDATION LOAN LOGIC:
- We offer ONE consolidation loan that gives them credit to pay off their other loans themselves
- The consolidation loan limit = total of all their outstanding loans (excluding Tala), UP TO A MAX OF $15,000 MXN
- The consolidation loan rate is SPECIFICALLY DESIGNED to reduce their monthly payment and total interest costs
- CRITICAL SAVINGS REQUIREMENT: The consolidation offer MUST save them at least $100 MXN per week in interest costs
- To ensure minimum savings:
  1. Calculate current total weekly interest: Sum of (each loan balance √ó weekly rate) for loans being consolidated
  2. Calculate new weekly interest: (total consolidation balance √ó weighted average weekly rate)
  3. If savings < $100 MXN/week, adjust the consolidation rate downward until savings ‚â• $100 MXN/week
  4. The adjusted rate becomes the consolidation offer rate - this rate is INTENTIONALLY LOWER to save them money
- IMPORTANT: Emphasize that this rate is designed specifically to reduce their costs: "This consolidation rate is designed to reduce your monthly payment and save you money on interest. Your current loans cost you $X/month. With consolidation at Y%, you'll pay $Z/month - that's $W saved every month!"

LOAN DATA COLLECTION:
- For each loan, collect ALL of these details:
  * Lender name
  * Outstanding balance (total debt)
  * Monthly payment amount
  * Payment frequency (monthly/weekly)
  * Interest rate (weekly or monthly)
- When they share a screenshot, extract ALL these details, not just balance and rate
- Confirm monthly payment amounts explicitly - this is crucial for showing savings
- If payment frequency is monthly, convert to weekly for interest calculations (divide by ~4.33)

BENEFITS TO EMPHASIZE:
- "No credit impact" - Checking their offer doesn't affect their credit score
- "One single payment" - Instead of juggling multiple payment dates
- "Always available" - Support when they need it

YOUR PERSONALITY:
- Warm and conversational, like talking to a trusted neighbor
- Use casual language, contractions, even the occasional emoji when it fits naturally
- Celebrate their good payment history genuinely
- Be empathetic about the stress of managing multiple loans
- Never sound like a bank robot or use corporate jargon
- Ask one question at a time, keep messages short and digestible
- Use their name occasionally (but not every message)

FLOW TO FOLLOW (they've already opted in, so skip the pitch):
1. GREETING: Warmly greet them, thank them for opting in, and let them know you're excited to help them simplify their finances. Mention the key benefits: no credit impact, one single payment, always available support.
2. EXPLAIN PROCESS: Briefly explain what you need - screenshots of 3 loans from other apps. Keep it simple and reassuring. Emphasize that checking their offer won't affect their credit score.
3. COLLECTION: Guide them through sharing screenshots one at a time. For each screenshot they share:
   - Acknowledge it warmly
   - Extract: lender name, outstanding balance, monthly payment amount, payment frequency, interest rate
   - Confirm these details with them
   - IMPORTANT: Make competitor rates higher than Tala's (typically 6-12% weekly or 25-50% monthly)
4. LOAN SELECTION: After collecting all loans, the system will automatically show a review screen. DO NOT try to calculate or show the offer yourself - the system handles this automatically.
5. SUMMARY & OFFER: CRITICAL - DO NOT calculate consolidation offers yourself. When 3+ loans are collected:
   - The system will automatically show a review screen with all loans
   - The system will automatically calculate and display the consolidation offer using deterministic calculations
   - You should NOT attempt to calculate rates, payments, or savings yourself
   - Simply acknowledge: "Perfect! I've collected all your loans. Let me show you your consolidation offer." and let the system display it
   - DO NOT say things like "Dame un momento para calcular" or "Te comparto pronto" - the offer appears automatically
   - DO NOT show placeholder calculations like "(ajustando para el ahorro necesario)" - wait for the system to show the actual offer
6. APPROVAL: After the system shows the offer, confirm they're approved and answer any questions they have.

IMPORTANT BEHAVIORS:
- When they share an image, analyze it and extract realistic loan details. Use Mexican lender names like: Kueski, Stori, Nu M√©xico, Mercado Cr√©dito, Creditea, Dineria, Konf√≠o, Credilikeme, Moneyman, or Cashclick
- CRITICAL: Competitor rates should be HIGHER than Tala's rate (from customer profile). This makes the weighted average attractive.
- Keep responses SHORT - 2-3 sentences max usually, EXCEPT for the final summary where you show the full consolidation math
- When presenting the consolidation offer, use clear structure: separate sections with line breaks, bold key numbers, make it easy to scan
- Avoid heavy markdown formatting - use simple bold (**text**) and line breaks for structure
- They already opted in, so don't re-pitch or ask if they're interested - they ARE
- If they seem hesitant about sharing, be reassuring about privacy/security
- ALWAYS respond in English
- Remember: max consolidation limit is $15,000 MXN even if their total debt is higher

CURRENCY: Always use Mexican pesos (MXN) with $ symbol, e.g., $5,000 MXN`;

        const SYSTEM_PROMPT_ES = `Eres Maya, una asesora de pr√©stamos amigable en Tala. Eres c√°lida, comprensiva y genuinamente quieres ayudar a los clientes a manejar mejor sus finanzas. Piensa en ti misma como esa amiga servicial de una cooperativa de cr√©dito del barrio - accesible, no corporativa.

TU ROL:
- Ayudar a los clientes a consolidar sus pr√©stamos en un solo pago simple
- Guiarlos para compartir detalles de pr√©stamos (capturas o texto)
- Calcular ofertas de consolidaci√≥n con tasas promedio ponderadas
- S√© emp√°tica sobre el estr√©s de manejar m√∫ltiples pr√©stamos

L√ìGICA DEL PR√âSTAMO DE CONSOLIDACI√ìN:
- UN pr√©stamo de consolidaci√≥n les da cr√©dito para que paguen sus otros pr√©stamos ellos mismos
- L√≠mite del pr√©stamo de consolidaci√≥n = total de todos los pr√©stamos pendientes (excluyendo Tala), HASTA UN M√ÅXIMO DE $15,000 MXN
- La tasa del pr√©stamo de consolidaci√≥n est√° ESPEC√çFICAMENTE DISE√ëADA para reducir su pago mensual y el costo total de intereses
- REQUISITO CR√çTICO DE AHORRO: La oferta de consolidaci√≥n DEBE ahorrarles al menos $100 MXN por semana en costos de inter√©s
- Para asegurar el ahorro m√≠nimo:
  1. Calcula el inter√©s semanal total actual: Suma de (cada saldo de pr√©stamo √ó tasa semanal) para pr√©stamos a consolidar
  2. Calcula el nuevo inter√©s semanal: (saldo total de consolidaci√≥n √ó tasa semanal promedio ponderada)
  3. Si el ahorro < $100 MXN/semana, ajusta la tasa de consolidaci√≥n hacia abajo hasta que el ahorro ‚â• $100 MXN/semana
  4. La tasa ajustada se convierte en la tasa de la oferta de consolidaci√≥n - esta tasa es INTENCIONALMENTE M√ÅS BAJA para ahorrarles dinero
- IMPORTANTE: Enfatiza que esta tasa est√° dise√±ada espec√≠ficamente para reducir sus costos: "Esta tasa de consolidaci√≥n est√° dise√±ada para reducir tu pago mensual y ahorrarte dinero en intereses. Tus pr√©stamos actuales te cuestan $X/mes. Con la consolidaci√≥n al Y%, pagar√°s $Z/mes - ¬°eso son $W ahorrados cada mes!"

RECOLECCI√ìN DE DATOS DEL PR√âSTAMO:
- Para cada pr√©stamo, recopila TODOS estos detalles:
  * Nombre del prestamista
  * Saldo pendiente (deuda total)
  * Monto del pago mensual
  * Frecuencia de pago (mensual/semanal)
  * Tasa de inter√©s (semanal o mensual)
- Cuando compartan una captura, extrae TODOS estos detalles, no solo el saldo y la tasa
- Confirma los montos de pago mensual expl√≠citamente - esto es crucial para mostrar ahorros
- Si la frecuencia de pago es mensual, convierte a semanal para c√°lculos de inter√©s (divide por ~4.33)

BENEFICIOS A ENFATIZAR:
- "Sin impacto por revisar tus finanzas" - Ver su oferta no afecta su score de cr√©dito
- "Un solo pago" - En vez de estar batallando con m√∫ltiples fechas de pago
- "Siempre disponible" - Te apoyamos cuando lo necesitas

TU PERSONALIDAD:
- C√°lida y conversacional, como hablar con un vecino de confianza
- Usa lenguaje casual, coloquial mexicano natural, emojis ocasionales cuando encajen
- Celebra genuinamente su buen historial de pagos
- Nunca suenes como un robot bancario ni uses jerga corporativa
- Haz una pregunta a la vez, mant√©n los mensajes cortos (2-3 oraciones usualmente)
- Usa su nombre ocasionalmente (pero no en cada mensaje)
- Usa "t√∫" no "usted" - queremos un tono cercano

FLUJO DE CONVERSACI√ìN:
1. SALUDO: Sal√∫dalos calurosamente, agrad√©celes por aceptar. Menciona los beneficios clave: sin impacto en cr√©dito, un solo pago, siempre disponible.
2. EXPLICAR PROCESO: Explica brevemente que necesitas detalles de 3 pr√©stamos de otras apps. Pueden compartir capturas o decirte los detalles. Enfatiza que ver su oferta no afecta su score de cr√©dito.
3. RECOLECCI√ìN: Gu√≠alos para compartir detalles de pr√©stamos uno por uno. Por cada pr√©stamo:
   - Si es una captura, anal√≠zala y extrae: nombre del prestamista, saldo pendiente, monto del pago mensual, frecuencia de pago, tasa de inter√©s
   - Si es texto, confirma los detalles con ellos
   - Reconoce calurosamente y confirma los detalles
   - IMPORTANTE: Las tasas de competidores deben ser M√ÅS ALTAS que la de Tala (t√≠picamente 6-12% semanal o 25-50% mensual)
4. SELECCI√ìN DE PR√âSTAMOS: Despu√©s de recopilar todos los pr√©stamos, el sistema mostrar√° autom√°ticamente una pantalla de revisi√≥n. NO intentes calcular o mostrar la oferta t√∫ misma - el sistema maneja esto autom√°ticamente.
5. RESUMEN Y OFERTA: CR√çTICO - NO calcules ofertas de consolidaci√≥n t√∫ misma. Cuando se recopilen 3+ pr√©stamos:
   - El sistema mostrar√° autom√°ticamente una pantalla de revisi√≥n con todos los pr√©stamos
   - El sistema calcular√° y mostrar√° autom√°ticamente la oferta de consolidaci√≥n usando c√°lculos determin√≠sticos
   - NO debes intentar calcular tasas, pagos o ahorros t√∫ misma
   - Simplemente reconoce: "¬°Perfecto! He recopilado todos tus pr√©stamos. D√©jame mostrarte tu oferta de consolidaci√≥n." y deja que el sistema la muestre
   - NO digas cosas como "Dame un momento para calcular" o "Te comparto pronto" - la oferta aparece autom√°ticamente
   - NO muestres c√°lculos con placeholders como "(ajustando para el ahorro necesario)" - espera a que el sistema muestre la oferta real
6. APROBACI√ìN: Despu√©s de que el sistema muestre la oferta, confirma que est√°n aprobados y responde cualquier pregunta que tengan.

COMPORTAMIENTOS IMPORTANTES:
- Cuando compartan una imagen, anal√≠zala y extrae detalles realistas del pr√©stamo
- Usa nombres de prestamistas mexicanos como: Kueski, Stori, Nu M√©xico, Mercado Cr√©dito, Creditea, Dineria, Konf√≠o, Credilikeme, Moneyman, o Cashclick
- CR√çTICO: Las tasas de competidores deben ser M√ÅS ALTAS que la tasa de Tala para hacer la consolidaci√≥n atractiva
- Mant√©n las respuestas CORTAS - 2-3 oraciones m√°ximo usualmente, EXCEPTO para el resumen final donde muestras todas las cuentas
- Al presentar la oferta de consolidaci√≥n, usa estructura clara: separa secciones con saltos de l√≠nea, usa negritas para n√∫meros clave, mantenlo f√°cil de escanear
- Evita formato markdown pesado - usa negritas simples (**texto**) y saltos de l√≠nea para estructura
- Ya aceptaron participar, as√≠ que no vuelvas a hacer pitch ni preguntes si est√°n interesados
- Si parecen dudosos, s√© tranquilizadora sobre privacidad/seguridad
- SIEMPRE responde en espa√±ol mexicano natural
- Recuerda: el l√≠mite m√°ximo de consolidaci√≥n es $15,000 MXN aunque su deuda total sea mayor

MONEDA: Siempre usa pesos mexicanos (MXN) con s√≠mbolo $, ej., $5,000 MXN

Rastrea la conversaci√≥n naturalmente - sabes d√≥nde est√°s en el flujo bas√°ndote en lo que se ha discutido.`;

        // DOM elements
        const elements = {
            messagesArea: document.getElementById('messagesArea'),
            messageInput: document.getElementById('messageInput'),
            messageForm: document.getElementById('messageForm'),
            fileInput: document.getElementById('fileInput'),
            imageBtn: document.getElementById('imageBtn'),
            sendBtn: document.getElementById('sendBtn'),
            resetBtn: document.getElementById('resetBtn'),
            langToggle: document.getElementById('langToggle'),
            applyRestartBtn: document.getElementById('applyRestartBtn'),
            customerNameInput: document.getElementById('customerNameInput'),
            currentLimitInput: document.getElementById('currentLimitInput'),
            currentRateInput: document.getElementById('currentRateInput'),
            currentTermInput: document.getElementById('currentTermInput'),
            title: document.getElementById('title'),
            subtitle: document.getElementById('subtitle'),
            demoTitle: document.getElementById('demoTitle'),
            customerLabel: document.getElementById('customerLabel'),
            limitLabel: document.getElementById('limitLabel'),
            rateLabel: document.getElementById('rateLabel'),
            termLabel: document.getElementById('termLabel')
        };

        // Initialize form values
        elements.customerNameInput.value = customerProfile.customerName;
        elements.currentLimitInput.value = customerProfile.currentLimit;
        elements.currentRateInput.value = customerProfile.currentRate;
        elements.currentTermInput.value = customerProfile.currentTerm;

        // Check authentication
        checkAuthentication();

        // Format message text with simple markdown support
        function formatMessage(text) {
            try {
                if (!text) return '';
                
                // Ensure text is a string
                if (typeof text !== 'string') {
                    text = String(text);
                }
                
                // Replace separator lines BEFORE escaping HTML (they're Unicode, not HTML)
                text = text.replace(/‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ/g, '___SEPARATOR___');
                
                // Escape HTML
                let html = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                
                // Replace separator placeholder with CSS border div
                html = html.replace(/___SEPARATOR___/g, '<div class="border-t border-gray-300 my-2 w-full"></div>');
                
                // Headers (### Header -> <strong>Header</strong>)
                html = html.replace(/###\s+(.+)/g, '<div class="font-bold text-base mt-2 mb-1">$1</div>');
                html = html.replace(/##\s+(.+)/g, '<div class="font-bold text-base mt-2 mb-1">$1</div>');
                html = html.replace(/#\s+(.+)/g, '<div class="font-bold text-base mt-2 mb-1">$1</div>');
                
                // Bold (**text** or __text__)
                html = html.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold">$1</strong>');
                html = html.replace(/__(.+?)__/g, '<strong class="font-semibold">$1</strong>');
                
                // Bullet lists (- item)
                html = html.replace(/^-\s+(.+)$/gm, '<div class="ml-2 mb-1">‚Ä¢ $1</div>');
                
                // Numbered lists (1. item)
                html = html.replace(/^\d+\.\s+(.+)$/gm, '<div class="ml-2 mb-1">$1</div>');
                
                // Line breaks
                html = html.replace(/\n/g, '<br>');
                
                return html;
            } catch (error) {
                console.error('Error in formatMessage:', error);
                return String(text || ''); // Return plain text if formatting fails
            }
        }

        // Update UI text based on language
        function updateUIText() {
            const t = UI_TEXT[language];
            elements.title.textContent = t.title;
            elements.subtitle.textContent = t.subtitle;
            elements.resetBtn.textContent = t.reset;
            elements.messageInput.placeholder = t.typePlaceholder;
            elements.demoTitle.textContent = t.demoTitle;
            elements.customerLabel.textContent = t.customer;
            elements.limitLabel.textContent = t.currentLimit;
            elements.rateLabel.textContent = t.currentRate;
            elements.termLabel.textContent = t.currentTerm;
            elements.langToggle.textContent = t.langToggle;
            elements.applyRestartBtn.textContent = t.applyRestart;
        }

        // Render messages
        function renderMessages() {
            elements.messagesArea.innerHTML = '';
            
            messages.forEach((msg) => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = `max-w-xs ${msg.role === 'user' ? 'order-2' : ''}`;
                
                if (msg.image) {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'mb-2 rounded-xl overflow-hidden border-2 border-teal-200 bg-gray-100';
                    const img = document.createElement('img');
                    img.src = msg.image;
                    img.alt = 'Uploaded loan screenshot';
                    img.className = 'w-full max-w-xs object-contain';
                    img.style.maxHeight = '400px';
                    imgDiv.appendChild(img);
                    contentDiv.appendChild(imgDiv);
                }
                
                const textDiv = document.createElement('div');
                textDiv.className = `px-4 py-2.5 rounded-2xl text-sm leading-relaxed ${
                    msg.role === 'user' 
                        ? 'bg-teal-500 text-white rounded-br-md' 
                        : 'bg-white text-gray-700 rounded-bl-md shadow-sm border border-gray-100'
                }`;
                
                // Simple markdown rendering for assistant messages
                if (msg.role === 'assistant') {
                    // Special styling for offer messages
                    if (msg.isOffer) {
                        textDiv.className = `px-4 py-3 rounded-2xl text-sm leading-relaxed bg-gradient-to-br from-teal-50 to-emerald-50 border-2 border-teal-300 shadow-md overflow-hidden break-words`;
                    }
                    
                    textDiv.innerHTML = formatMessage(msg.content);
                    
                    // Append textDiv first
                    contentDiv.appendChild(textDiv);
                    
                    // Add confirmation buttons if needed
                    if (msg.needsConfirmation && pendingLoanConfirmation) {
                        const buttonDiv = document.createElement('div');
                        buttonDiv.className = 'flex gap-2 mt-3';
                        buttonDiv.innerHTML = `
                            <button class="confirm-loan-btn flex-1 px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                ${language === 'es' ? '‚úì S√≠, es correcto' : '‚úì Yes, correct'}
                            </button>
                            <button class="reject-loan-btn flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                ${language === 'es' ? '‚úó No, corregir' : '‚úó No, correct'}
                            </button>
                        `;
                        contentDiv.appendChild(buttonDiv);
                        
                        // Add event listeners
                        buttonDiv.querySelector('.confirm-loan-btn').addEventListener('click', () => {
                            confirmLoan(pendingLoanConfirmation);
                        });
                        buttonDiv.querySelector('.reject-loan-btn').addEventListener('click', () => {
                            rejectLoan();
                        });
                    }
                    
                    // Remove "View offer" button - offer shows automatically
                    // Keeping showOfferButton check for backward compatibility but not rendering button
                    if (msg.showOfferButton && false) {
                        const buttonDiv = document.createElement('div');
                        buttonDiv.className = 'mt-3';
                        const viewOfferBtn = document.createElement('button');
                        viewOfferBtn.className = 'w-full px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white rounded-lg text-sm font-semibold transition-colors';
                        viewOfferBtn.textContent = language === 'es' ? 'Ver oferta' : 'View offer';
                        viewOfferBtn.addEventListener('click', () => {
                            showConsolidationOffer();
                        });
                        buttonDiv.appendChild(viewOfferBtn);
                        contentDiv.appendChild(buttonDiv);
                    }
                    
                    // Add extra 20% option buttons for offer
                    if (msg.hasExtraOption && msg.isOffer) {
                        const buttonDiv = document.createElement('div');
                        buttonDiv.className = 'flex gap-2 mt-3';
                        buttonDiv.innerHTML = `
                            <button class="accept-extra-btn flex-1 px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white rounded-lg text-sm font-semibold transition-colors">
                                ${language === 'es' ? '‚úì S√≠, agregar 20%' : '‚úì Yes, add 20%'}
                            </button>
                            <button class="decline-extra-btn flex-1 px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg text-sm font-semibold transition-colors">
                                ${language === 'es' ? 'No, as√≠ est√° bien' : 'No, this is fine'}
                            </button>
                        `;
                        contentDiv.appendChild(buttonDiv);
                        
                        // Add event listeners
                        buttonDiv.querySelector('.accept-extra-btn').addEventListener('click', () => {
                            acceptExtraAmount(msg);
                        });
                        buttonDiv.querySelector('.decline-extra-btn').addEventListener('click', () => {
                            declineExtraAmount(msg);
                        });
                    }
                } else {
                    textDiv.textContent = msg.content;
                    contentDiv.appendChild(textDiv);
                }
                
                msgDiv.appendChild(contentDiv);
                elements.messagesArea.appendChild(msgDiv);
            });
            
            if (isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="bg-white px-4 py-3 rounded-2xl rounded-bl-md shadow-sm border border-gray-100">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                            <div class="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                            <div class="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                        </div>
                    </div>
                `;
                elements.messagesArea.appendChild(loadingDiv);
            }
            
            elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
        }

        // Welcome messages
        function getWelcomeMessage() {
            const name = customerProfile.customerName;
            if (language === 'es') {
                return `¬°Hola ${name}! üëã Qu√© gusto que aceptaste esta oportunidad. Soy Maya de Tala, y estoy aqu√≠ para ayudarte a consolidar todos tus pr√©stamos en uno solo.

En los pr√≥ximos minutos, vamos a revisar tus pr√©stamos de otras apps y te voy a mostrar c√≥mo puedes simplificar todo en un solo pago, con una tasa m√°s baja y menos estr√©s.

¬øLista para empezar? Solo necesito que compartas capturas de 3 pr√©stamos que tengas con otras apps.`;
            } else {
                return `Hey ${name}! üëã So glad you opted in for this opportunity. I'm Maya from Tala, and I'm here to help you consolidate all your loans into one.

Over the next few minutes, we'll review your loans from other apps and I'll show you how you can simplify everything into one payment, with a lower rate and less stress.

Ready to get started? I just need you to share screenshots of 3 loans you have with other apps.`;
            }
        }

        // Start conversation
        async function startConversation() {
            isLoading = true;
            renderMessages();
            
            // Initialize progress
            updateProgress(1, 4);

            // Use hardcoded welcome message
            const welcomeMessage = getWelcomeMessage();

            messages = [{ role: 'assistant', content: welcomeMessage }];
            isLoading = false;
            renderMessages();
        }

        // Update progress indicator
        function updateProgress(step, totalSteps = 4) {
            const progressIndicator = document.getElementById('progressIndicator');
            const progressStep = document.getElementById('progressStep');
            const progressPercent = document.getElementById('progressPercent');
            const progressBar = document.getElementById('progressBar');
            
            if (!progressIndicator) return;
            
            const percent = (step / totalSteps) * 100;
            const stepLabels = language === 'es'
                ? ['Recopilando pr√©stamos', 'Revisando detalles', 'Calculando oferta', 'Ver oferta']
                : ['Collecting loans', 'Reviewing details', 'Calculating offer', 'View offer'];
            
            progressIndicator.classList.remove('hidden');
            progressStep.textContent = `${stepLabels[step - 1]} (${step}/${totalSteps})`;
            progressPercent.textContent = `${Math.round(percent)}%`;
            progressBar.style.width = `${percent}%`;
        }

        // Handle loan confirmation
        function confirmLoan(loanData) {
            extractedLoans.push(loanData);
            pendingLoanConfirmation = null;
            
            // Update progress
            const currentStep = Math.min(extractedLoans.length, 3);
            updateProgress(currentStep);
            
            const confirmMsg = language === 'es'
                ? `¬°Perfecto! He registrado tu pr√©stamo con **${loanData.lender}** por **$${parseFloat(loanData.balance).toLocaleString()} MXN** con una tasa de **${loanData.weeklyRate}%** semanal. ${extractedLoans.length < 3 ? '¬øTienes otro pr√©stamo que compartir?' : ''}`
                : `Perfect! I've recorded your loan with **${loanData.lender}** for **$${parseFloat(loanData.balance).toLocaleString()} MXN** at **${loanData.weeklyRate}%** weekly rate. ${extractedLoans.length < 3 ? 'Do you have another loan to share?' : ''}`;
            
            messages.push({ role: 'assistant', content: confirmMsg });
            renderMessages();
            
            // If we have 3+ loans, automatically show review screen (don't wait for LLM response)
            if (extractedLoans.length >= 3) {
                // Small delay to let confirmation message render first
                setTimeout(() => {
                    showReviewScreen();
                }, 500);
            }
        }

        function rejectLoan() {
            pendingLoanConfirmation = null;
            const rejectMsg = language === 'es'
                ? 'No hay problema. ¬øPuedes compartir la captura de nuevo o decirme los detalles del pr√©stamo?'
                : 'No problem. Can you share the screenshot again or tell me the loan details?';
            messages.push({ role: 'assistant', content: rejectMsg });
            renderMessages();
        }

        // Handle extra 20% option
        function acceptExtraAmount(offerMsg) {
            const offer = offerMsg.baseOffer;
            const extraAmount = offerMsg.extraAmount;
            const newTotal = offerMsg.extraTotal;
            const newMonthlyPayment = newTotal * (offer.consolidationRate / 100) * 4.33;
            
            // Helper function to format currency consistently (2 decimals)
            const formatCurrency = (amount) => {
                return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            };
            
            const debtPayoff = offerMsg.debtPayoffAmount || Math.min(offer.totalBalance, 15000);
            
            const confirmText = language === 'es'
                ? `¬°Perfecto! He actualizado tu oferta:

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üí∞ **Nuevo l√≠mite total**

**$${formatCurrency(newTotal)} MXN**

**Desglose:**
‚Ä¢ **$${formatCurrency(debtPayoff)}** disponible para consolidar tus deudas
‚Ä¢ **$${formatCurrency(extraAmount)}** adicionales para tus gastos

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üíµ **Nuevo pago mensual**

**$${formatCurrency(newMonthlyPayment)} MXN/mes**

**Tasa:** ${offer.consolidationRate.toFixed(2)}% semanal (sin cambios)

**Ahorras:** **$${formatCurrency(offer.monthlySavings)} cada mes** üí∞

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

¬°Excelente decisi√≥n! Ahora tienes m√°s flexibilidad para cubrir cualquier gasto que surja sin tener que ir con otros prestamistas. üéâ`
                : `Perfect! I've updated your offer:

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üí∞ **New total limit**

**$${formatCurrency(newTotal)} MXN**

**Breakdown:**
‚Ä¢ **$${formatCurrency(debtPayoff)}** available to consolidate your debts
‚Ä¢ **$${formatCurrency(extraAmount)}** extra for your expenses

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üíµ **New monthly payment**

**$${formatCurrency(newMonthlyPayment)} MXN/month**

**Rate:** ${offer.consolidationRate.toFixed(2)}% weekly (no change)

**You save:** **$${formatCurrency(offer.monthlySavings)} each month** üí∞

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

Great decision! Now you have more flexibility to cover any expenses that come up without needing to go to other lenders. üéâ`;
            
            messages.push({ role: 'assistant', content: confirmText });
            renderMessages();
        }

        function declineExtraAmount(offerMsg) {
            const confirmText = language === 'es'
                ? 'Perfecto, la oferta base est√° lista para ti. ¬øHay algo m√°s en lo que pueda ayudarte?'
                : 'Perfect, the base offer is ready for you. Is there anything else I can help with?';
            messages.push({ role: 'assistant', content: confirmText });
            renderMessages();
        }

        // Show review screen
        function showReviewScreen() {
            updateProgress(3, 4);
            
            // Include Tala loan in review
            const talaLoan = {
                lender: 'Tala',
                balance: customerProfile.currentLimit,
                weeklyRate: customerProfile.currentRate,
                monthlyPayment: customerProfile.currentLimit * (customerProfile.currentRate / 100) * 4.33
            };
            const allLoansForReview = [talaLoan, ...extractedLoans];
            
            const totalMonthlyPayment = calculateTotalMonthlyPayment(allLoansForReview);
            const totalBalance = allLoansForReview.reduce((sum, loan) => sum + (parseFloat(loan.balance) || 0), 0);
            
            const consolidationLoanCount = extractedLoans.length;
            const consolidationTotal = extractedLoans.reduce((sum, loan) => sum + (parseFloat(loan.balance) || 0), 0);
            const consolidationMonthlyPayment = calculateTotalMonthlyPayment(extractedLoans);
            
            const reviewText = language === 'es'
                ? `**Revisi√≥n de tus pr√©stamos**

He recopilado la informaci√≥n de tus pr√©stamos:

${allLoansForReview.map((loan, idx) => `‚Ä¢ **${loan.lender}**: $${parseFloat(loan.balance).toLocaleString()} MXN (${loan.weeklyRate}% semanal)`).join('\n')}

**Resumen:**
‚Ä¢ **Pago mensual total:** $${totalMonthlyPayment.toLocaleString()}/mes
‚Ä¢ **Deuda total:** $${totalBalance.toLocaleString()}
‚Ä¢ **Consolidar√°s ${consolidationLoanCount} ${consolidationLoanCount === 1 ? 'pr√©stamo' : 'pr√©stamos'} en 1** ($${consolidationTotal.toLocaleString()} MXN)

¬°Perfecto! Ahora puedo mostrarte tu oferta de consolidaci√≥n con todos los detalles.`
                : `**Review your loans**

I've collected information about your loans:

${allLoansForReview.map((loan, idx) => `‚Ä¢ **${loan.lender}**: $${parseFloat(loan.balance).toLocaleString()} MXN (${loan.weeklyRate}% weekly)`).join('\n')}

**Summary:**
‚Ä¢ **Total monthly payment:** $${totalMonthlyPayment.toLocaleString()}/month
‚Ä¢ **Total debt:** $${totalBalance.toLocaleString()}
‚Ä¢ **You'll consolidate ${consolidationLoanCount} ${consolidationLoanCount === 1 ? 'loan' : 'loans'} into 1** ($${consolidationTotal.toLocaleString()} MXN)

Perfect! Now I can show you your consolidation offer with all the details.`;
            
            messages.push({ role: 'assistant', content: reviewText, showOfferButton: true });
            renderMessages();
            
            // Automatically show offer after a brief moment
            setTimeout(() => {
                showConsolidationOffer();
            }, 1500);
        }

        // Show consolidation offer using deterministic calculations
        function showConsolidationOffer() {
            updateProgress(4, 4);
            const offer = calculateConsolidationOffer(extractedLoans, customerProfile.currentRate, customerProfile.currentLimit);
            
            // Verify that the offer actually reduces costs
            if (offer.monthlySavings <= 0 || offer.weeklySavings <= 0) {
                console.warn('Warning: Offer does not provide savings. Monthly:', offer.monthlySavings, 'Weekly:', offer.weeklySavings);
            }
            
            // Helper function to format currency consistently (2 decimals)
            const formatCurrency = (amount) => {
                return parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            };
            
            // Calculate total cost comparison (principal + interest over term)
            const termMonths = customerProfile.currentTerm || 1;
            const totalCostCurrent = offer.currentMonthlyPayment * termMonths;
            const totalCostNew = offer.newMonthlyPayment * termMonths;
            const totalCostSavings = totalCostCurrent - totalCostNew;
            
            // Calculate breakdown - clarify credit limit vs debt payoff
            // Don't include Tala loan - only consolidate other loans
            const totalDebt = extractedLoans.reduce((sum, loan) => sum + (parseFloat(loan.balance) || 0), 0);
            const debtPayoffAmount = Math.min(totalDebt, 15000); // Actual debt to pay off (other loans only)
            const creditLimit = Math.min(offer.totalBalance, 15000); // Total credit limit offered
            const availableCredit = Math.max(0, creditLimit - debtPayoffAmount); // Remaining credit after paying debt
            const additional20Percent = Math.floor(creditLimit * 0.2);
            const totalWithExtra = Math.min(creditLimit + additional20Percent, 15000);
            const extraAvailable = Math.max(0, totalWithExtra - creditLimit);
            
            let offerText = language === 'es'
                ? `üéâ **¬°Tu oferta est√° lista!**

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üíµ **TU NUEVO PAGO MENSUAL**

**$${formatCurrency(offer.newMonthlyPayment)} MXN/mes**

**Antes:** ~~$${formatCurrency(offer.currentMonthlyPayment)}/mes~~
**Ahora:** **$${formatCurrency(offer.newMonthlyPayment)}/mes**
**Ahorras:** **$${formatCurrency(offer.monthlySavings)} MXN cada mes** üí∞

*Esta tasa est√° dise√±ada espec√≠ficamente para reducir tu pago mensual y el costo total de tus pr√©stamos.*

${termMonths > 1 ? `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üìä **REDUCCI√ìN DEL COSTO TOTAL (INTERESES)**

**Costo total actual (principal + intereses):** ~~$${formatCurrency(totalCostCurrent)} MXN~~
**Costo total consolidado:** **$${formatCurrency(totalCostNew)} MXN**
**Ahorras en intereses:** **$${formatCurrency(totalCostSavings)} MXN** üéâ

*Esta oferta est√° dise√±ada para reducir significativamente el costo total de tus pr√©stamos. Ahorras $${formatCurrency(offer.monthlySavings)} cada mes en pagos, y $${formatCurrency(totalCostSavings)} en total durante los ${termMonths} meses.*` : ''}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üí∞ **Tu nuevo l√≠mite de cr√©dito**

**$${formatCurrency(creditLimit)} MXN**

**Este cr√©dito cubre tus ${offer.loanCount || extractedLoans.length} ${(offer.loanCount || extractedLoans.length) === 1 ? 'pr√©stamo' : 'pr√©stamos'} actuales**

**Desglose:**
‚Ä¢ **$${formatCurrency(debtPayoffAmount)}** disponible para pagar tus deudas
${availableCredit > 0 ? `‚Ä¢ **$${formatCurrency(availableCredit)}** disponible para usar cuando lo necesites` : ''}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üìã **Detalles de tu oferta**

‚Ä¢ **Tasa consolidada:** ${offer.consolidationRate.toFixed(2)}% semanal *(dise√±ada para reducir tus costos)*
‚Ä¢ **Plazo:** ${termMonths} ${termMonths === 1 ? 'mes' : 'meses'}
‚Ä¢ **Ahorro semanal en intereses:** **$${formatCurrency(offer.weeklySavings)} MXN**
‚Ä¢ **Ahorro mensual en pagos:** **$${formatCurrency(offer.monthlySavings)} MXN**

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úÖ **¬°Est√°s aprobado!** Usa este cr√©dito para pagar tus otros pr√©stamos y simplifica todo en un solo pago.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üí° ¬øNecesitas m√°s para tus gastos?

Puedo aumentar tu l√≠mite en **20% adicional** ($${formatCurrency(additional20Percent)} MXN m√°s) con la misma tasa.

**Beneficios:**
‚Ä¢ **$${formatCurrency(additional20Percent)} MXN** adicionales disponibles
‚Ä¢ **Misma tasa:** ${offer.consolidationRate.toFixed(2)}% semanal
‚Ä¢ **Un solo lugar** para todos tus pr√©stamos

¬øTe gustar√≠a agregar estos $${formatCurrency(additional20Percent)} MXN adicionales?`
                : `üéâ **Your offer is here!**

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üíµ **YOUR NEW MONTHLY PAYMENT**

**$${formatCurrency(offer.newMonthlyPayment)} MXN/month**

**Before:** ~~$${formatCurrency(offer.currentMonthlyPayment)}/month~~
**Now:** **$${formatCurrency(offer.newMonthlyPayment)}/month**
**Save:** **$${formatCurrency(offer.monthlySavings)} MXN each month** üí∞

*This rate is specifically designed to reduce your monthly payment and the total cost of your loans.*

${termMonths > 1 ? `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üìä **TOTAL COST REDUCTION (INTEREST)**

**Current total cost (principal + interest):** ~~$${formatCurrency(totalCostCurrent)} MXN~~
**Consolidated total cost:** **$${formatCurrency(totalCostNew)} MXN**
**Save on interest:** **$${formatCurrency(totalCostSavings)} MXN** üéâ

*This offer is designed to significantly reduce the total cost of your loans. You save $${formatCurrency(offer.monthlySavings)} each month in payments, and $${formatCurrency(totalCostSavings)} total over ${termMonths} months.*` : ''}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üí∞ **Your new credit limit**

**$${formatCurrency(creditLimit)} MXN**

**This credit covers all ${offer.loanCount || extractedLoans.length} of your current ${(offer.loanCount || extractedLoans.length) === 1 ? 'loan' : 'loans'}**

**Breakdown:**
‚Ä¢ **$${formatCurrency(debtPayoffAmount)}** available to payoff your debt
${availableCredit > 0 ? `‚Ä¢ **$${formatCurrency(availableCredit)}** available to borrow whenever you need` : ''}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üìã **Your offer details**

‚Ä¢ **Consolidated rate:** ${offer.consolidationRate.toFixed(2)}% weekly *(designed to reduce your costs)*
‚Ä¢ **Term:** ${termMonths} ${termMonths === 1 ? 'month' : 'months'}
‚Ä¢ **Weekly interest savings:** **$${formatCurrency(offer.weeklySavings)} MXN**
‚Ä¢ **Monthly payment savings:** **$${formatCurrency(offer.monthlySavings)} MXN**

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

‚úÖ **You're approved!** Use this credit to pay off your other loans and simplify everything into one payment.

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

### üí° Need more for your expenses?

I can increase your limit by an additional **20%** ($${formatCurrency(additional20Percent)} MXN more) with the same rate.

**Benefits:**
‚Ä¢ **$${formatCurrency(additional20Percent)} MXN** extra available
‚Ä¢ **Same rate:** ${offer.consolidationRate.toFixed(2)}% weekly
‚Ä¢ **One place** for all your loans

Would you like to add this extra $${formatCurrency(additional20Percent)} MXN?`;
            
            messages.push({ 
                role: 'assistant', 
                content: offerText, 
                isOffer: true,
                hasExtraOption: true,
                extraAmount: additional20Percent,
                extraTotal: totalWithExtra,
                baseOffer: offer,
                creditLimit: creditLimit,
                debtPayoffAmount: debtPayoffAmount
            });
            renderMessages();
        }

        // Send message (clean - no state management)
        async function sendMessage(userMessage, imageData = null) {
            if (!userMessage.trim() && !imageData) return;

            // Add user message
            const userMsg = { 
                role: 'user', 
                content: userMessage || (imageData ? (language === 'es' ? 'Aqu√≠ est√° mi captura del pr√©stamo' : 'Here\'s my loan screenshot') : ''),
                image: imageData 
            };
            messages.push(userMsg);
            elements.messageInput.value = '';
            isLoading = true;
            renderMessages();

            // Check if this is a loan image - use structured output
            const isLoanImage = !!imageData;
            const systemPrompt = buildSystemPrompt(isLoanImage);

            // Build messages for backend API
            const apiMessages = messages.map(msg => {
                if (msg.role === 'user' && msg.image) {
                    // For images, use vision API format
                    return {
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: msg.content || (language === 'es' 
                                    ? 'Estoy compartiendo una captura de un pr√©stamo. Por favor anal√≠zala y extrae el nombre del prestamista, saldo pendiente y tasa de inter√©s.'
                                    : 'I\'m sharing a loan screenshot. Please analyze it and extract the lender name, outstanding balance, and interest rate.')
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: msg.image
                                }
                            }
                        ]
                    };
                }
                return { role: msg.role, content: msg.content };
            });

            try {
                const response = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: 'openai',
                        model: 'gpt-4o',
                        max_tokens: isLoanImage ? 300 : 500,
                        system: systemPrompt,
                        messages: apiMessages,
                        useStructuredOutput: isLoanImage,
                        sessionId: `debt-consolidation-${Date.now()}`,
                        userId: customerProfile.customerName
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('API Error:', response.status, errorData);
                    throw new Error(errorData.error || errorData.details || 'API request failed');
                }

                const data = await response.json();
                console.log('API Response:', data);
                
                // Handle structured output (loan extraction)
                if (isLoanImage && data.parsedContent) {
                    const loanData = data.parsedContent;
                    // Validate loan data
                    if (loanData.lender && loanData.balance && loanData.weeklyRate) {
                        // Convert monthly rate to weekly if needed
                        if (loanData.monthlyRate && !loanData.weeklyRate) {
                            loanData.weeklyRate = loanData.monthlyRate / 4.33;
                        }
                        // Store for confirmation
                        pendingLoanConfirmation = loanData;
                        // Show confirmation message
                        // Format interest rate display (show as displayed in screenshot)
                        let rateDisplay = '';
                        if (loanData.monthlyRate && loanData.paymentFrequency === 'mensual') {
                            rateDisplay = language === 'es' 
                                ? `${loanData.monthlyRate}% mensual`
                                : `${loanData.monthlyRate}% monthly`;
                        } else {
                            rateDisplay = language === 'es'
                                ? `${loanData.weeklyRate}% semanal`
                                : `${loanData.weeklyRate}% weekly`;
                        }
                        
                        const confirmText = language === 'es'
                            ? `Veo que tienes un pr√©stamo con **${loanData.lender}** por **$${parseFloat(loanData.balance).toLocaleString()} MXN** con una tasa de inter√©s de **${rateDisplay}**. ¬øEs correcto?`
                            : `I see you have a loan with **${loanData.lender}** for **$${parseFloat(loanData.balance).toLocaleString()} MXN** at an interest rate of **${rateDisplay}**. Is this correct?`;
                        messages.push({ role: 'assistant', content: confirmText, needsConfirmation: true });
                    } else {
                        throw new Error('Invalid loan data structure');
                    }
                } else {
                    // Regular text response
                    let assistantMessage = data.content?.[0]?.text || data.content || 'Error: Invalid response';
                    // Ensure it's a string
                    if (typeof assistantMessage !== 'string') {
                        assistantMessage = String(assistantMessage);
                    }
                    messages.push({ role: 'assistant', content: assistantMessage });
                }
            } catch (error) {
                console.error('Error sending message:', error);
                console.error('Error details:', error.message);
                // Show more helpful error message
                let errorMsg;
                if (error.message.includes('OPENAI_API_KEY')) {
                    errorMsg = language === 'es'
                        ? 'Error de configuraci√≥n del servidor. Por favor, contacta al administrador.'
                        : 'Server configuration error. Please contact the administrator.';
                } else if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    errorMsg = language === 'es'
                        ? 'Error de conexi√≥n. Por favor, verifica tu conexi√≥n a internet.'
                        : 'Connection error. Please check your internet connection.';
                } else {
                    errorMsg = language === 'es' 
                        ? `¬°Ups, perd√≥n por eso! Tuve un peque√±o problema: ${error.message}. ¬øPuedes intentar de nuevo?`
                        : `Oops, sorry about that! Had a little hiccup: ${error.message}. Mind trying again?`;
                }
                messages.push({ role: 'assistant', content: errorMsg });
            }
            
            isLoading = false;
            renderMessages();
        }

        // Authentication functions
        function checkAuthentication() {
            const stored = sessionStorage.getItem('demo_authenticated');
            if (stored === 'true') {
                isAuthenticated = true;
                document.getElementById('passwordModal').classList.add('hidden');
                startConversation();
            } else {
                document.getElementById('passwordModal').classList.remove('hidden');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');

            if (username === DEMO_CREDENTIALS.username && password === DEMO_CREDENTIALS.password) {
                isAuthenticated = true;
                sessionStorage.setItem('demo_authenticated', 'true');
                document.getElementById('passwordModal').classList.add('hidden');
                startConversation();
            } else {
                errorDiv.textContent = 'Invalid username or password';
                errorDiv.classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
            }
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', handleLogin);

        elements.messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage(elements.messageInput.value);
        });

        elements.imageBtn.addEventListener('click', () => {
            elements.fileInput.click();
        });

        elements.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageData = event.target.result;
                    const defaultMsg = language === 'es' ? 'Aqu√≠ est√° mi captura del pr√©stamo' : "Here's my loan screenshot";
                    sendMessage(elements.messageInput.value || defaultMsg, imageData);
                    elements.messageInput.value = '';
                };
                reader.readAsDataURL(file);
            }
        });

        elements.resetBtn.addEventListener('click', () => {
            messages = [];
            startConversation();
        });

        elements.langToggle.addEventListener('click', () => {
            language = language === 'es' ? 'en' : 'es';
            messages = [];
            updateUIText();
            startConversation();
        });

        elements.applyRestartBtn.addEventListener('click', () => {
            customerProfile = {
                customerName: elements.customerNameInput.value,
                currentLimit: Number(elements.currentLimitInput.value),
                currentRate: Number(elements.currentRateInput.value),
                currentTerm: Number(elements.currentTermInput.value)
            };
            messages = [];
            startConversation();
        });

        // API key input no longer needed

        // Initialize
        updateUIText();
        // Conversation will start automatically if API key exists (handled above)
    </script>
</body>
</html>