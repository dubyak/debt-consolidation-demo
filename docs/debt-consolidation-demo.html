<!DOCTYPE html>
<!--
    Debt Consolidation Demo - Clean Chat Agent Version
    ===================================================
    
    This version uses OpenAI API directly with a clean chat interface.
    The LLM handles the entire flow naturally through conversation.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tala - Debt Consolidation Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
        }
        .api-key-input {
            font-family: monospace;
            font-size: 0.75rem;
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50 flex flex-col items-center justify-center p-4">
        <!-- API Key Setup Modal -->
        <div id="apiKeyModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                <h2 class="text-xl font-bold text-gray-800 mb-2">ðŸ”‘ OpenAI API Key Required</h2>
                <p class="text-sm text-gray-600 mb-4">
                    Enter your OpenAI API key to use this demo. Your key is stored locally in your browser.
                </p>
                <input
                    type="password"
                    id="apiKeyInput"
                    placeholder="sk-..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 api-key-input focus:outline-none focus:ring-2 focus:ring-teal-500"
                />
                <div class="flex gap-2">
                    <button
                        id="saveApiKeyBtn"
                        class="flex-1 px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white rounded-lg font-semibold transition-colors"
                    >
                        Save & Continue
                    </button>
                    <a
                        href="https://platform.openai.com/api-keys"
                        target="_blank"
                        class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg font-semibold transition-colors text-center"
                    >
                        Get Key
                    </a>
                </div>
            </div>
        </div>

        <!-- Phone Frame -->
        <div class="w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden border-8 border-gray-800 relative">
            <!-- Status Bar -->
            <div class="bg-gray-800 text-white px-6 py-2 flex justify-between items-center text-xs">
                <span>9:41</span>
                <div class="flex gap-1 items-center">
                    <div class="w-4 h-2 border border-white rounded-sm relative">
                        <div class="absolute inset-0.5 bg-white rounded-sm" style="width: 80%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-teal-500 to-emerald-500 px-4 py-4 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center">
                    <span class="text-xl">ðŸŒ¿</span>
                </div>
                <div class="flex-1">
                    <h1 id="title" class="text-white font-semibold text-lg tracking-tight">Tala</h1>
                    <p id="subtitle" class="text-teal-100 text-xs">Tu aliado financiero</p>
                </div>
                <div class="flex items-center gap-2">
                    <button 
                        id="langToggle"
                        class="px-2 py-1 bg-white/20 hover:bg-white/30 text-white text-xs font-semibold rounded-lg transition-colors"
                    >
                        EN
                    </button>
                    <button 
                        id="resetBtn"
                        class="text-white/70 hover:text-white text-xs underline"
                    >
                        Reiniciar
                    </button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesArea" class="h-96 overflow-y-auto p-4 space-y-3 bg-gray-50">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-100 bg-white p-3">
                <form id="messageForm" class="flex gap-2 items-end">
                    <button
                        type="button"
                        id="imageBtn"
                        class="w-10 h-10 rounded-full bg-teal-100 hover:bg-teal-200 flex items-center justify-center text-teal-600 transition-colors flex-shrink-0"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <input
                        type="file"
                        id="fileInput"
                        accept="image/*"
                        class="hidden"
                    />
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="Escribe un mensaje..."
                        class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-teal-300 transition-all"
                    />
                    <button
                        type="submit"
                        id="sendBtn"
                        class="w-10 h-10 rounded-full bg-teal-500 hover:bg-teal-600 disabled:bg-gray-300 flex items-center justify-center text-white transition-colors flex-shrink-0"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- Settings Panel -->
        <div class="mt-6 max-w-sm w-full bg-white/90 backdrop-blur rounded-xl p-4 shadow-lg">
            <h2 id="demoTitle" class="font-bold text-teal-800 mb-3 text-sm">ðŸ§ª ConfiguraciÃ³n</h2>
            <div class="space-y-3">
                <!-- API Key Section -->
                <div class="pb-3 border-b border-gray-200">
                    <label class="text-xs text-gray-500 block mb-1">OpenAI API Key</label>
                    <div class="flex gap-2">
                        <input
                            type="password"
                            id="apiKeyDisplay"
                            placeholder="sk-..."
                            class="flex-1 px-3 py-2 text-xs border border-gray-200 rounded-lg api-key-input focus:outline-none focus:ring-2 focus:ring-teal-300"
                            readonly
                        />
                        <button
                            id="changeApiKeyBtn"
                            class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-semibold rounded-lg transition-colors"
                        >
                            Cambiar
                        </button>
                    </div>
                </div>

                <div>
                    <label id="customerLabel" class="text-xs text-gray-500 block mb-1">Nombre del Cliente</label>
                    <input
                        type="text"
                        id="customerNameInput"
                        class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-300"
                    />
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <label id="limitLabel" class="text-xs text-gray-500 block mb-1">LÃ­mite Tala (MXN)</label>
                        <input
                            type="number"
                            id="currentLimitInput"
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-300"
                        />
                    </div>
                    <div>
                        <label id="rateLabel" class="text-xs text-gray-500 block mb-1">Tasa (%/semana)</label>
                        <input
                            type="number"
                            step="0.1"
                            id="currentRateInput"
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-300"
                        />
                    </div>
                    <div>
                        <label id="termLabel" class="text-xs text-gray-500 block mb-1">Plazo (semanas)</label>
                        <input
                            type="number"
                            id="currentTermInput"
                            class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-300"
                        />
                    </div>
                </div>
                <button
                    id="applyRestartBtn"
                    class="w-full px-4 py-2 bg-teal-500 hover:bg-teal-600 text-white text-xs font-semibold rounded-lg transition-colors"
                >
                    Aplicar y Reiniciar
                </button>
            </div>
        </div>
    </div>

    <script>
        const UI_TEXT = {
            en: {
                title: 'Tala',
                subtitle: 'Your loan buddy',
                reset: 'Reset',
                typePlaceholder: 'Type a message...',
                demoTitle: 'ðŸ§ª Settings',
                customer: 'Customer Name',
                currentLimit: 'Tala Limit (MXN)',
                currentRate: 'Rate (%/week)',
                currentTerm: 'Term (weeks)',
                langToggle: 'ES',
                applyRestart: 'Apply & Restart',
                changeKey: 'Change'
            },
            es: {
                title: 'Tala',
                subtitle: 'Tu aliado financiero',
                reset: 'Reiniciar',
                typePlaceholder: 'Escribe un mensaje...',
                demoTitle: 'ðŸ§ª ConfiguraciÃ³n',
                customer: 'Nombre del Cliente',
                currentLimit: 'LÃ­mite Tala (MXN)',
                currentRate: 'Tasa (%/semana)',
                currentTerm: 'Plazo (semanas)',
                langToggle: 'EN',
                applyRestart: 'Aplicar y Reiniciar',
                changeKey: 'Cambiar'
            }
        };

        // Customer profile defaults
        const DEFAULT_PROFILE = {
            customerName: 'MarÃ­a',
            currentLimit: 3000,
            currentRate: 4.5,
            currentTerm: 4
        };

        // State
        let messages = [];
        let language = 'es';
        let isLoading = false;
        let customerProfile = { ...DEFAULT_PROFILE };

        // Get OpenAI API key from localStorage
        function getApiKey() {
            return localStorage.getItem('openai_api_key');
        }

        function setApiKey(key) {
            localStorage.setItem('openai_api_key', key);
            updateApiKeyDisplay();
        }

        function updateApiKeyDisplay() {
            const key = getApiKey();
            if (key) {
                const masked = key.length > 8 ? `sk-...${key.slice(-4)}` : 'sk-...';
                elements.apiKeyDisplay.value = masked;
                elements.apiKeyDisplay.type = 'text';
            } else {
                elements.apiKeyDisplay.value = '';
            }
        }

        // Build system prompt with customer info
        function buildSystemPrompt() {
            const lang = language === 'es' ? 'ES' : 'EN';
            const customerInfo = language === 'es'
                ? `Nombre: ${customerProfile.customerName}, LÃ­mite actual en Tala: $${customerProfile.currentLimit.toLocaleString()} MXN, Tasa Tala: ${customerProfile.currentRate}%/semana, Plazo: ${customerProfile.currentTerm} semanas`
                : `Name: ${customerProfile.customerName}, Current Tala limit: $${customerProfile.currentLimit.toLocaleString()} MXN, Tala rate: ${customerProfile.currentRate}%/week, Term: ${customerProfile.currentTerm} weeks`;

            const basePrompt = language === 'es' ? SYSTEM_PROMPT_ES : SYSTEM_PROMPT_EN;
            return `${basePrompt}\n\nCUSTOMER PROFILE:\n${customerInfo}\n\nIMPORTANT: Track the conversation flow naturally. When the customer shares loan screenshots, analyze them and extract: lender name, outstanding balance, and interest rate. After collecting 3+ loans, present the consolidation offer with calculations.`;
        }

        const SYSTEM_PROMPT_EN = `You are Maya, a friendly loan advisor at Tala. You're warm, supportive, and genuinely want to help customers manage their finances better. Think of yourself as that helpful friend at a neighborhood credit cooperative - approachable, not corporate.

YOUR ROLE:
- Help customers consolidate their loans into one simple payment
- Guide them through sharing loan details (screenshots or text)
- Calculate consolidation offers with weighted average rates
- Be empathetic about the stress of managing multiple loans

CONSOLIDATION LOAN LOGIC:
- ONE consolidation loan pays off ALL their other loans (including any outstanding Tala balance)
- Consolidation loan limit = total of all outstanding loans, UP TO A MAX OF $15,000 MXN
- Consolidation loan rate = WEIGHTED AVERAGE of all loan rates (including Tala's rate)
- If they have expensive loans elsewhere, consolidating brings their blended rate DOWN
- Show the math: "Your current loans average X% interest. With consolidation, you get one simple payment at Y% - that's Z pesos saved per week!"

YOUR PERSONALITY:
- Warm and conversational, like talking to a trusted neighbor
- Use casual language, contractions, occasional emoji when natural
- Celebrate their good payment history genuinely
- Never sound like a bank robot or use corporate jargon
- Ask one question at a time, keep messages short (2-3 sentences usually)
- Use their name occasionally (but not every message)

CONVERSATION FLOW:
1. GREETING: Warmly greet them, thank them for opting in. They've already opted in - skip the pitch.
2. EXPLAIN PROCESS: Briefly explain you need details about 3 loans from other apps. They can share screenshots or tell you the details.
3. COLLECTION: Guide them through sharing loan details one at a time. For each loan:
   - If it's a screenshot, analyze it and extract: lender name, outstanding balance, interest rate
   - If it's text, confirm the details with them
   - Acknowledge warmly and confirm the details
   - IMPORTANT: Competitor rates should be HIGHER than Tala's rate (typically 6-12% weekly or 25-50% monthly)
4. SUMMARY & OFFER: After 3+ loans shared, present the consolidation offer:
   - List all loans: Tala + the ones they shared (lender, balance, rate)
   - Calculate TOTAL outstanding balance (cap at $15,000 MXN if higher)
   - Calculate the WEIGHTED AVERAGE rate across all loans
   - Show the consolidation offer: ONE loan for the total amount at the blended rate
   - Emphasize benefits: "Instead of juggling multiple payments at different rates, you get ONE payment, ONE due date, and a lower blended rate"
   - Calculate weekly/monthly savings in pesos
5. APPROVAL: Confirm they're approved! The consolidation loan will pay off their other loans directly.

IMPORTANT BEHAVIORS:
- When they share an image, analyze it and extract realistic loan details
- Use Mexican lender names like: Kueski, Stori, Nu MÃ©xico, Mercado CrÃ©dito, Creditea, Dineria, KonfÃ­o, Credilikeme, Moneyman, or Cashclick
- CRITICAL: Competitor rates should be HIGHER than Tala's rate to make consolidation attractive
- Keep responses SHORT - 2-3 sentences max usually, EXCEPT for the final summary where you show full consolidation math
- They already opted in, so don't re-pitch or ask if they're interested
- If they seem hesitant, be reassuring about privacy/security
- ALWAYS respond in English
- Remember: max consolidation limit is $15,000 MXN even if their total debt is higher

CURRENCY: Always use Mexican pesos (MXN) with $ symbol, e.g., $5,000 MXN

Track the conversation naturally - you know where you are in the flow based on what's been discussed.`;

        const SYSTEM_PROMPT_ES = `Eres Maya, una asesora de prÃ©stamos amigable en Tala. Eres cÃ¡lida, comprensiva y genuinamente quieres ayudar a los clientes a manejar mejor sus finanzas. Piensa en ti misma como esa amiga servicial de una cooperativa de crÃ©dito del barrio - accesible, no corporativa.

TU ROL:
- Ayudar a los clientes a consolidar sus prÃ©stamos en un solo pago simple
- Guiarlos para compartir detalles de prÃ©stamos (capturas o texto)
- Calcular ofertas de consolidaciÃ³n con tasas promedio ponderadas
- SÃ© empÃ¡tica sobre el estrÃ©s de manejar mÃºltiples prÃ©stamos

LÃ“GICA DEL PRÃ‰STAMO DE CONSOLIDACIÃ“N:
- UN prÃ©stamo de consolidaciÃ³n paga TODOS sus otros prÃ©stamos (incluyendo cualquier saldo pendiente de Tala)
- LÃ­mite del prÃ©stamo de consolidaciÃ³n = total de todos los prÃ©stamos pendientes, HASTA UN MÃXIMO DE $15,000 MXN
- Tasa del prÃ©stamo de consolidaciÃ³n = PROMEDIO PONDERADO de todas las tasas (incluyendo la de Tala)
- Si tienen prÃ©stamos caros en otros lados, consolidar baja su tasa combinada
- MuÃ©strales las cuentas: "Tus prÃ©stamos actuales promedian X% de interÃ©s. Con la consolidaciÃ³n, tienes un solo pago al Y% - Â¡eso son Z pesos menos por semana!"

TU PERSONALIDAD:
- CÃ¡lida y conversacional, como hablar con un vecino de confianza
- Usa lenguaje casual, coloquial mexicano natural, emojis ocasionales cuando encajen
- Celebra genuinamente su buen historial de pagos
- Nunca suenes como un robot bancario ni uses jerga corporativa
- Haz una pregunta a la vez, mantÃ©n los mensajes cortos (2-3 oraciones usualmente)
- Usa su nombre ocasionalmente (pero no en cada mensaje)
- Usa "tÃº" no "usted" - queremos un tono cercano

FLUJO DE CONVERSACIÃ“N:
1. SALUDO: SalÃºdalos calurosamente, agradÃ©celes por aceptar. Ya aceptaron participar - salta el pitch.
2. EXPLICAR PROCESO: Explica brevemente que necesitas detalles de 3 prÃ©stamos de otras apps. Pueden compartir capturas o decirte los detalles.
3. RECOLECCIÃ“N: GuÃ­alos para compartir detalles de prÃ©stamos uno por uno. Por cada prÃ©stamo:
   - Si es una captura, analÃ­zala y extrae: nombre del prestamista, saldo pendiente, tasa de interÃ©s
   - Si es texto, confirma los detalles con ellos
   - Reconoce calurosamente y confirma los detalles
   - IMPORTANTE: Las tasas de competidores deben ser MÃS ALTAS que la de Tala (tÃ­picamente 6-12% semanal o 25-50% mensual)
4. RESUMEN Y OFERTA: DespuÃ©s de 3+ prÃ©stamos compartidos, presenta la oferta de consolidaciÃ³n:
   - Lista todos los prÃ©stamos: Tala + los que compartieron (prestamista, saldo, tasa)
   - Calcula el saldo TOTAL pendiente (tope en $15,000 MXN si es mayor)
   - Calcula la tasa PROMEDIO PONDERADO de todos los prÃ©stamos
   - Muestra la oferta de consolidaciÃ³n: UN prÃ©stamo por el monto total a la tasa combinada
   - Enfatiza los beneficios: "En vez de estar batallando con mÃºltiples pagos a diferentes tasas, tienes UN solo pago, UNA fecha de vencimiento, y una tasa combinada mÃ¡s baja"
   - Calcula el ahorro semanal/mensual en pesos
5. APROBACIÃ“N: Â¡Confirma que estÃ¡n aprobados! El prÃ©stamo de consolidaciÃ³n pagarÃ¡ sus otros prÃ©stamos directamente.

COMPORTAMIENTOS IMPORTANTES:
- Cuando compartan una imagen, analÃ­zala y extrae detalles realistas del prÃ©stamo
- Usa nombres de prestamistas mexicanos como: Kueski, Stori, Nu MÃ©xico, Mercado CrÃ©dito, Creditea, Dineria, KonfÃ­o, Credilikeme, Moneyman, o Cashclick
- CRÃTICO: Las tasas de competidores deben ser MÃS ALTAS que la tasa de Tala para hacer la consolidaciÃ³n atractiva
- MantÃ©n las respuestas CORTAS - 2-3 oraciones mÃ¡ximo usualmente, EXCEPTO para el resumen final donde muestras todas las cuentas
- Ya aceptaron participar, asÃ­ que no vuelvas a hacer pitch ni preguntes si estÃ¡n interesados
- Si parecen dudosos, sÃ© tranquilizadora sobre privacidad/seguridad
- SIEMPRE responde en espaÃ±ol mexicano natural
- Recuerda: el lÃ­mite mÃ¡ximo de consolidaciÃ³n es $15,000 MXN aunque su deuda total sea mayor

MONEDA: Siempre usa pesos mexicanos (MXN) con sÃ­mbolo $, ej., $5,000 MXN

Rastrea la conversaciÃ³n naturalmente - sabes dÃ³nde estÃ¡s en el flujo basÃ¡ndote en lo que se ha discutido.`;

        // DOM elements
        const elements = {
            apiKeyModal: document.getElementById('apiKeyModal'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            apiKeyDisplay: document.getElementById('apiKeyDisplay'),
            saveApiKeyBtn: document.getElementById('saveApiKeyBtn'),
            changeApiKeyBtn: document.getElementById('changeApiKeyBtn'),
            messagesArea: document.getElementById('messagesArea'),
            messageInput: document.getElementById('messageInput'),
            messageForm: document.getElementById('messageForm'),
            fileInput: document.getElementById('fileInput'),
            imageBtn: document.getElementById('imageBtn'),
            sendBtn: document.getElementById('sendBtn'),
            resetBtn: document.getElementById('resetBtn'),
            langToggle: document.getElementById('langToggle'),
            applyRestartBtn: document.getElementById('applyRestartBtn'),
            customerNameInput: document.getElementById('customerNameInput'),
            currentLimitInput: document.getElementById('currentLimitInput'),
            currentRateInput: document.getElementById('currentRateInput'),
            currentTermInput: document.getElementById('currentTermInput'),
            title: document.getElementById('title'),
            subtitle: document.getElementById('subtitle'),
            demoTitle: document.getElementById('demoTitle'),
            customerLabel: document.getElementById('customerLabel'),
            limitLabel: document.getElementById('limitLabel'),
            rateLabel: document.getElementById('rateLabel'),
            termLabel: document.getElementById('termLabel')
        };

        // Initialize form values
        elements.customerNameInput.value = customerProfile.customerName;
        elements.currentLimitInput.value = customerProfile.currentLimit;
        elements.currentRateInput.value = customerProfile.currentRate;
        elements.currentTermInput.value = customerProfile.currentTerm;

        // Check for API key on load
        if (!getApiKey()) {
            elements.apiKeyModal.classList.remove('hidden');
        } else {
            updateApiKeyDisplay();
            // Start conversation automatically if API key exists
            startConversation();
        }

        // Update UI text based on language
        function updateUIText() {
            const t = UI_TEXT[language];
            elements.title.textContent = t.title;
            elements.subtitle.textContent = t.subtitle;
            elements.resetBtn.textContent = t.reset;
            elements.messageInput.placeholder = t.typePlaceholder;
            elements.demoTitle.textContent = t.demoTitle;
            elements.customerLabel.textContent = t.customer;
            elements.limitLabel.textContent = t.currentLimit;
            elements.rateLabel.textContent = t.currentRate;
            elements.termLabel.textContent = t.currentTerm;
            elements.langToggle.textContent = t.langToggle;
            elements.applyRestartBtn.textContent = t.applyRestart;
            elements.changeApiKeyBtn.textContent = t.changeKey;
        }

        // Render messages
        function renderMessages() {
            elements.messagesArea.innerHTML = '';
            
            messages.forEach((msg) => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = `max-w-xs ${msg.role === 'user' ? 'order-2' : ''}`;
                
                if (msg.image) {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'mb-1 rounded-xl overflow-hidden border-2 border-teal-200';
                    const img = document.createElement('img');
                    img.src = msg.image;
                    img.alt = 'Uploaded loan';
                    img.className = 'w-full max-h-32 object-cover';
                    imgDiv.appendChild(img);
                    contentDiv.appendChild(imgDiv);
                }
                
                const textDiv = document.createElement('div');
                textDiv.className = `px-4 py-2.5 rounded-2xl text-sm leading-relaxed ${
                    msg.role === 'user' 
                        ? 'bg-teal-500 text-white rounded-br-md' 
                        : 'bg-white text-gray-700 rounded-bl-md shadow-sm border border-gray-100'
                }`;
                textDiv.textContent = msg.content;
                contentDiv.appendChild(textDiv);
                
                msgDiv.appendChild(contentDiv);
                elements.messagesArea.appendChild(msgDiv);
            });
            
            if (isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="bg-white px-4 py-3 rounded-2xl rounded-bl-md shadow-sm border border-gray-100">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                            <div class="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                            <div class="w-2 h-2 bg-teal-400 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                        </div>
                    </div>
                `;
                elements.messagesArea.appendChild(loadingDiv);
            }
            
            elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
        }

        // Start conversation
        async function startConversation() {
            const apiKey = getApiKey();
            if (!apiKey) {
                elements.apiKeyModal.classList.remove('hidden');
                return;
            }

            isLoading = true;
            renderMessages();

            const systemPrompt = buildSystemPrompt();
            const greetingPrompt = language === 'es'
                ? 'Inicia la conversaciÃ³n con un saludo cÃ¡lido. El cliente ya aceptÃ³ participar en la oportunidad de consolidaciÃ³n.'
                : 'Start the conversation with a warm greeting. The customer has already opted in to the consolidation opportunity.';

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 500,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: greetingPrompt }
                        ]
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || 'API request failed');
                }
                
                const data = await response.json();
                const assistantMessage = data.choices?.[0]?.message?.content || 'Hello! How can I help you today?';
                messages = [{ role: 'assistant', content: assistantMessage }];
            } catch (error) {
                console.error('Error starting conversation:', error);
                const errorMsg = error.message.includes('API key') 
                    ? 'Invalid API key. Please check your OpenAI API key.'
                    : 'Error starting conversation. Please try again.';
                messages = [{ role: 'assistant', content: errorMsg }];
            }
            isLoading = false;
            renderMessages();
        }

        // Send message (clean - no state management)
        async function sendMessage(userMessage, imageData = null) {
            const apiKey = getApiKey();
            if (!apiKey) {
                elements.apiKeyModal.classList.remove('hidden');
                return;
            }

            if (!userMessage.trim() && !imageData) return;

            // Add user message
            const userMsg = { 
                role: 'user', 
                content: userMessage || (imageData ? 'Here\'s my loan screenshot' : ''),
                image: imageData 
            };
            messages.push(userMsg);
            elements.messageInput.value = '';
            isLoading = true;
            renderMessages();

            // Build messages for API
            const systemPrompt = buildSystemPrompt();
            const apiMessages = [
                { role: 'system', content: systemPrompt },
                ...messages.map(msg => {
                    if (msg.role === 'user' && msg.image) {
                        // For images, use vision API format
                        return {
                            role: 'user',
                            content: [
                                {
                                    type: 'text',
                                    text: msg.content || 'I\'m sharing a loan screenshot. Please analyze it and extract the lender name, outstanding balance, and interest rate.'
                                },
                                {
                                    type: 'image_url',
                                    image_url: {
                                        url: msg.image
                                    }
                                }
                            ]
                        };
                    }
                    return { role: msg.role, content: msg.content };
                })
            ];

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 500,
                        messages: apiMessages
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || 'API request failed');
                }

                const data = await response.json();
                const assistantMessage = data.choices?.[0]?.message?.content || 'Error: Invalid response';
                messages.push({ role: 'assistant', content: assistantMessage });
            } catch (error) {
                console.error('Error sending message:', error);
                const errorMsg = language === 'es' 
                    ? `Â¡Ups, perdÃ³n por eso! ${error.message.includes('API key') ? 'Por favor verifica tu API key de OpenAI.' : 'Tuve un pequeÃ±o problema. Â¿Puedes intentar de nuevo?'}`
                    : `Oops, sorry about that! ${error.message.includes('API key') ? 'Please check your OpenAI API key.' : 'Had a little hiccup on my end. Mind trying again?'}`;
                messages.push({ role: 'assistant', content: errorMsg });
            }
            
            isLoading = false;
            renderMessages();
        }

        // Event listeners
        elements.saveApiKeyBtn.addEventListener('click', () => {
            const key = elements.apiKeyInput.value.trim();
            if (key && key.startsWith('sk-')) {
                setApiKey(key);
                elements.apiKeyModal.classList.add('hidden');
                elements.apiKeyInput.value = '';
                startConversation();
            } else {
                alert('Please enter a valid OpenAI API key (starts with sk-)');
            }
        });

        elements.changeApiKeyBtn.addEventListener('click', () => {
            elements.apiKeyModal.classList.remove('hidden');
            elements.apiKeyInput.value = '';
            elements.apiKeyInput.focus();
        });

        elements.messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage(elements.messageInput.value);
        });

        elements.imageBtn.addEventListener('click', () => {
            elements.fileInput.click();
        });

        elements.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageData = event.target.result;
                    const defaultMsg = language === 'es' ? 'AquÃ­ estÃ¡ mi captura del prÃ©stamo' : "Here's my loan screenshot";
                    sendMessage(elements.messageInput.value || defaultMsg, imageData);
                    elements.messageInput.value = '';
                };
                reader.readAsDataURL(file);
            }
        });

        elements.resetBtn.addEventListener('click', () => {
            messages = [];
            startConversation();
        });

        elements.langToggle.addEventListener('click', () => {
            language = language === 'es' ? 'en' : 'es';
            messages = [];
            updateUIText();
            startConversation();
        });

        elements.applyRestartBtn.addEventListener('click', () => {
            customerProfile = {
                customerName: elements.customerNameInput.value,
                currentLimit: Number(elements.currentLimitInput.value),
                currentRate: Number(elements.currentRateInput.value),
                currentTerm: Number(elements.currentTermInput.value)
            };
            messages = [];
            startConversation();
        });

        elements.apiKeyInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                elements.saveApiKeyBtn.click();
            }
        });

        // Initialize
        updateUIText();
        // Conversation will start automatically if API key exists (handled above)
    </script>
</body>
</html>