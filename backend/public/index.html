<!DOCTYPE html>
<!--
    Tala Credit Limit Increase Demo - "Dumb Terminal" Architecture
    ==============================================================
    
    The LLM handles ALL flow logic, calculations, and decision-making.
    Frontend just sends messages and displays responses.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tala - Credit Limit Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Nunito', sans-serif; }
        :root {
            --orange-primary: #FF6B35;
            --orange-hover: #E55A2B;
        }
        .andrea-image {
            object-fit: cover;
            object-position: center center;
            width: 100%;
            height: 100%;
        }
        .message-content h1, .message-content h2, .message-content h3 {
            font-weight: 700;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
        }
        .message-content ul, .message-content ol {
            margin-left: 1rem;
            margin-bottom: 0.5rem;
        }
        .message-content li {
            margin-bottom: 0.25rem;
        }
        .message-content p {
            margin-bottom: 0.5rem;
        }
        .message-content strong {
            font-weight: 700;
        }
        .offer-card {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border-radius: 1rem;
            padding: 1rem;
            color: white;
            margin: 0.5rem 0;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 8px 12px;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #9CA3AF;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'orange-primary': '#FF6B35',
                        'orange-hover': '#E55A2B',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4">
        <!-- Password Protection Modal -->
        <div id="passwordModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-emerald-400 to-teal-500 flex items-center justify-center mx-auto mb-4 overflow-hidden">
                        <img src="images/andrea.png" alt="Andrea" class="andrea-image rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <span class="text-3xl" style="display:none;">üë©‚Äçüíº</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Tala Demo</h2>
                    <p class="text-sm text-gray-600">Enter your credentials to access</p>
                </div>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 block mb-1">Username</label>
                        <input type="text" id="usernameInput" placeholder="Enter username"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]/20 focus:border-[#FF6B35]"
                            autocomplete="username" />
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 block mb-1">Password</label>
                        <input type="password" id="passwordInput" placeholder="Enter password"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]/20 focus:border-[#FF6B35]"
                            autocomplete="current-password" />
                    </div>
                    <div id="loginError" class="text-red-500 text-xs text-center hidden"></div>
                    <button type="submit"
                        class="w-full px-4 py-2 bg-[#FF6B35] hover:bg-[#E55A2B] text-white rounded-lg font-semibold transition-colors shadow-sm">
                        Access Demo
                    </button>
                </form>
            </div>
        </div>

        <!-- Phone Frame -->
        <div class="w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden border-8 border-gray-800 relative">
            <!-- Status Bar -->
            <div class="bg-gray-800 text-white px-6 py-2 flex justify-between items-center text-xs">
                <span>9:41</span>
                <div class="flex gap-1 items-center">
                    <div class="w-4 h-2 border border-white rounded-sm relative">
                        <div class="absolute inset-0.5 bg-white rounded-sm" style="width: 80%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-emerald-400 to-teal-500 px-4 py-4 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center overflow-hidden">
                    <img src="images/andrea.png" alt="Andrea" class="andrea-image rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="text-xl" style="display:none;">üë©‚Äçüíº</span>
                </div>
                <div class="flex-1 flex items-center gap-2">
                    <div>
                        <h1 id="title" class="text-white font-semibold text-lg tracking-tight">Andrea de Tala</h1>
                        <p id="subtitle" class="text-white/90 text-xs">Tu asesora financiera</p>
                    </div>
                </div>
                <button id="resetBtn" class="text-white/80 hover:text-white text-xs underline">Reiniciar</button>
            </div>

            <!-- Messages Area -->
            <div id="messagesArea" class="h-96 overflow-y-auto p-4 space-y-3 bg-white"></div>

            <!-- Input Area -->
            <div class="border-t border-gray-100 bg-white p-3">
                <form id="messageForm" class="flex gap-2 items-end">
                    <button type="button" id="imageBtn"
                        class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors flex-shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <input type="file" id="fileInput" accept="image/*" class="hidden" />
                    <input type="text" id="messageInput" placeholder="Escribe un mensaje..."
                        class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FF6B35]/20 transition-all" />
                    <button type="submit" id="sendBtn"
                        class="w-10 h-10 rounded-full bg-[#FF6B35] hover:bg-[#E55A2B] disabled:bg-gray-300 flex items-center justify-center text-white transition-colors flex-shrink-0">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const BACKEND_URL = window.location.origin;
        const DEMO_CREDENTIALS = { username: 'Talajote', password: 'StackWithT@la' };
        
        // Demo customer profile (hardcoded for demo)
        const CUSTOMER = {
            name: 'Mar√≠a',
            currentLimit: 5000,
            currentRate: 4.5
        };

        // ========================================
        // SYSTEM PROMPT - ALL FLOW LOGIC LIVES HERE
        // ========================================
        const SYSTEM_PROMPT = `Eres Andrea, una asesora de pr√©stamos amigable en Tala. Eres c√°lida, comprensiva y genuinamente quieres ayudar a los clientes.

PERFIL DEL CLIENTE:
- Nombre: ${CUSTOMER.name}
- L√≠mite actual de Tala: $${CUSTOMER.currentLimit.toLocaleString()} MXN
- Tasa actual: ${CUSTOMER.currentRate}% semanal
- Ha completado 5 pr√©stamos exitosamente con Tala

REGLAS DEL PRODUCTO (no negociables):
- L√≠mite base nuevo = m√≠nimo(l√≠mite_actual √ó 1.2, 15,000 MXN)
- L√≠mite m√°ximo absoluto: $15,000 MXN
- Plazo: 2 meses (2 pagos mensuales)
- Tasa: misma tasa que su pr√©stamo actual (${CUSTOMER.currentRate}% semanal)
- Cashback: $100 MXN por cada pago a tiempo (m√°ximo $200 por los 2 pagos)
- L√≠nea de emergencia: $1,000 MXN, hasta 15 d√≠as, 0% inter√©s si se paga a tiempo

C√ÅLCULOS:
- Para ${CUSTOMER.name}: $${CUSTOMER.currentLimit} √ó 1.2 = $${Math.min(CUSTOMER.currentLimit * 1.2, 15000).toLocaleString()} MXN (l√≠mite base)

TU PERSONALIDAD:
- C√°lida y conversacional, como hablar con un vecino de confianza
- Usa lenguaje casual, coloquial mexicano natural, emojis ocasionales
- Haz UNA pregunta a la vez
- Mant√©n mensajes cortos (2-3 oraciones m√°ximo)
- Usa "t√∫" no "usted"

FLUJO DE CONVERSACI√ìN:

1. SALUDO C√ÅLIDO E INTENCI√ìN (env√≠a esto inmediatamente al iniciar)
   - Saluda calurosamente a ${CUSTOMER.name}
   - Di algo como: "¬°Hola ${CUSTOMER.name}! üëã Soy Andrea de Tala. Quiero entender tu situaci√≥n y ver si podemos ofrecerte un pr√©stamo que se adapte a tus necesidades y te recompense por pagar a tiempo."
   - Luego haz tu primera pregunta

2. RECOPILACI√ìN R√ÅPIDA DE INFORMACI√ìN (una pregunta a la vez)
   a) Pregunta: "¬øCu√°l es tu l√≠mite actual con Tala?" (aunque lo sabemos, confirmamos)
   b) Pregunta: "¬øPara qu√© usas normalmente Tala?"
   c) Pregunta: "¬øPara qu√© necesitas el dinero esta vez?"
   d) Pregunta: "¬øCu√°l es aproximadamente tu ingreso mensual y cada cu√°nto lo recibes (semanal/quincenal/mensual)?"

3. CONSTRUIR Y PRESENTAR OFERTA BASE
   Despu√©s de recopilar la informaci√≥n:
   
   - Calcula l√≠mite_base = m√≠nimo(l√≠mite_confirmado √ó 1.2, 15000)
   - VERIFICACI√ìN DE ASEQUIBILIDAD: Internamente, verifica que el pago mensual estimado no exceda ~30% de su ingreso mensual. Si parece alto, menciona que el monto est√° dise√±ado para ser manejable.
   
   Presenta la oferta:
   
   ---
   üí∞ **Tu Oferta Tala**
   
   üìä **Detalles del pr√©stamo:**
   ‚Ä¢ Monto: $[l√≠mite_base] MXN
   ‚Ä¢ Plazo: 2 meses (2 pagos mensuales)
   ‚Ä¢ Tasa: ${CUSTOMER.currentRate}% semanal
   
   üéÅ **Beneficios especiales:**
   ‚Ä¢ Cashback: $100 MXN por cada pago a tiempo (hasta $200)
   ‚Ä¢ L√≠nea de emergencia: $1,000 MXN disponibles por 15 d√≠as a 0% inter√©s
   
   ---
   
   SI el l√≠mite base >= $13,000 MXN:
   - Presenta la oferta como su m√°ximo por ahora
   - Di: "Este es el l√≠mite m√°s alto que puedo ofrecerte ahora mismo bas√°ndome en tu historial con Tala."
   
   SI el l√≠mite base < $13,000 MXN:
   - Presenta la oferta y luego pregunta:
   - "¬øTe parece bien esta oferta, o te gustar√≠a ver si puedes calificar para un l√≠mite m√°s alto (hasta un m√°ximo de $15,000 pesos)?"

4. SI ACEPTAN LA OFERTA BASE
   - Reconfirma: monto, plazo de 2 meses (2 pagos), tasa, cashback, l√≠nea de emergencia
   - Obt√©n aceptaci√≥n
   - Recu√©rdales: pago a tiempo ‚Üí cashback + mejores ofertas futuras
   - Cierra la conversaci√≥n celebrando

5. SI QUIEREN L√çMITE M√ÅS ALTO (solo cuando base < $13k)
   
   a) Pregunta c√≥mo usar√°n el dinero extra:
      "Si aumentamos tu l√≠mite por encima de $[l√≠mite_base] MXN, ¬øpara qu√© usar√≠as espec√≠ficamente el monto adicional?"
   
   b) Establece expectativas:
      "Podr√≠amos aumentar tu l√≠mite entre un 10-30% m√°s, hasta $15,000 pesos. No est√° garantizado; necesitar√© evidencia que respalde un l√≠mite m√°s alto."
   
   c) Recopilaci√≥n guiada de evidencia:
      P√≠deles compartir cualquier combinaci√≥n de:
      ‚Ä¢ Fotos de negocio (tienda, inventario, actividad)
      ‚Ä¢ Otras ofertas/l√≠mites de pr√©stamos en los √∫ltimos 3 meses
      ‚Ä¢ Comprobantes de ingresos (capturas de dep√≥sitos, n√≥minas, transferencias)
      ‚Ä¢ Cualquier otra cosa que crean que ayude
      
      Ciclo: recibe ‚Üí reconoce ‚Üí "¬øAlgo m√°s?" ‚Üí para cuando digan que terminaron

6. EVALUAR Y OFERTA FINAL
   
   Bas√°ndote en la evidencia, decide internamente el nivel de aumento:
   - Sin aumento (0%): evidencia d√©bil o ninguna
   - +10%: algo de evidencia, uso razonable
   - +20%: buena evidencia, uso productivo claro
   - +30%: evidencia fuerte, m√∫ltiples fuentes
   
   L√≠mite final = m√≠nimo(l√≠mite_base √ó (1 + porcentaje/100), 15000)
   
   Verificaci√≥n de asequibilidad: aseg√∫rate de que el nuevo monto sigue siendo razonable vs su ingreso.
   
   SI hay aumento:
   - Explica qu√© evidencia + uso de fondos lo justific√≥
   - Presenta nuevo monto con misma estructura (2 meses/2 pagos, misma tasa, cashback, l√≠nea emergencia)
   
   SI no hay aumento:
   - Explica amablemente por qu√© es m√°s seguro quedarse con el monto base
   - Mant√©n recompensas + l√≠nea de emergencia
   - Enmarca este pr√©stamo como un paso hacia l√≠mites m√°s altos en el futuro
   
   Confirma aceptaci√≥n y cierra celebrando.

FORMATO DE OFERTAS:
Siempre usa este formato visual para las ofertas:

---
üí∞ **Tu Oferta Tala**

üìä **Detalles del pr√©stamo:**
‚Ä¢ Monto: $X,XXX MXN
‚Ä¢ Plazo: 2 meses (2 pagos mensuales)
‚Ä¢ Tasa: ${CUSTOMER.currentRate}% semanal

üéÅ **Beneficios especiales:**
‚Ä¢ Cashback: $100 MXN por cada pago a tiempo (hasta $200)
‚Ä¢ L√≠nea de emergencia: $1,000 MXN disponibles por 15 d√≠as a 0% inter√©s

---

REGLAS IMPORTANTES:
- Responde en el mismo idioma que use el cliente. Si escriben en ingl√©s, responde en ingl√©s. Si escriben en espa√±ol, responde en espa√±ol mexicano natural.
- Una pregunta a la vez
- Mensajes cortos y amigables
- Celebra sus logros y buen historial
- S√© emp√°tica con sus necesidades financieras
- Nunca suenes como un robot bancario

CUANDO ANALICES IM√ÅGENES DE EVIDENCIA:
- Describe brevemente lo que ves
- Reconoce el esfuerzo del cliente
- Pregunta si tienen algo m√°s que compartir`;

        // ========================================
        // STATE - Minimal, just messages
        // ========================================
        let messages = [];
        let isLoading = false;
        let isAuthenticated = false;

        // ========================================
        // DOM ELEMENTS
        // ========================================
        const elements = {
            messagesArea: document.getElementById('messagesArea'),
            messageInput: document.getElementById('messageInput'),
            messageForm: document.getElementById('messageForm'),
            fileInput: document.getElementById('fileInput'),
            imageBtn: document.getElementById('imageBtn'),
            sendBtn: document.getElementById('sendBtn'),
            resetBtn: document.getElementById('resetBtn'),
            passwordModal: document.getElementById('passwordModal'),
            loginForm: document.getElementById('loginForm'),
            usernameInput: document.getElementById('usernameInput'),
            passwordInput: document.getElementById('passwordInput'),
            loginError: document.getElementById('loginError')
        };

        // ========================================
        // RENDER MESSAGES
        // ========================================
        function renderMessages() {
            elements.messagesArea.innerHTML = '';
            
            messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'max-w-xs';
                
                // Show image if present
                if (msg.image) {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'mb-2 rounded-xl overflow-hidden border-2 border-gray-200 bg-gray-100';
                    const img = document.createElement('img');
                    img.src = msg.image;
                    img.alt = 'Uploaded image';
                    img.className = 'w-full max-w-xs object-contain';
                    img.style.maxHeight = '200px';
                    imgDiv.appendChild(img);
                    contentDiv.appendChild(imgDiv);
                }
                
                // Message bubble
                const bubble = document.createElement('div');
                bubble.className = msg.role === 'user' 
                    ? 'bg-[#FF6B35] text-white rounded-2xl rounded-br-md px-4 py-2.5 text-sm'
                    : 'bg-gray-100 text-gray-800 rounded-2xl rounded-bl-md px-4 py-2.5 text-sm message-content';
                
                // Render markdown for assistant messages
                if (msg.role === 'assistant' && typeof marked !== 'undefined') {
                    bubble.innerHTML = marked.parse(msg.content || '');
                } else {
                    bubble.textContent = msg.content || '';
                }
                
                contentDiv.appendChild(bubble);
                msgDiv.appendChild(contentDiv);
                elements.messagesArea.appendChild(msgDiv);
            });
            
            // Show loading indicator
            if (isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="bg-gray-100 rounded-2xl rounded-bl-md">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;
                elements.messagesArea.appendChild(loadingDiv);
            }
            
            // Scroll to bottom
            elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
        }

        // ========================================
        // SEND MESSAGE - The core function
        // ========================================
        async function sendMessage(userText = '', imageBase64 = null) {
            if (isLoading) return;
            if (!userText.trim() && !imageBase64) return;
            
            isLoading = true;
            
            // Add user message to history
            const userMessage = { role: 'user', content: userText };
            if (imageBase64) {
                userMessage.image = imageBase64;
            }
            messages.push(userMessage);
            renderMessages();
            
            try {
                // Build API messages
                const apiMessages = messages.map(msg => {
                    if (msg.image) {
                        return {
                            role: msg.role,
                            content: [
                                { type: 'text', text: msg.content || 'Aqu√≠ est√° mi evidencia' },
                                { type: 'image_url', image_url: { url: msg.image } }
                            ]
                        };
                    }
                    return { role: msg.role, content: msg.content };
                });
                
                // Call API
                const response = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: 'openai',
                        model: 'gpt-4o',
                        max_tokens: 1000,
                        system: SYSTEM_PROMPT,
                        messages: apiMessages
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                const assistantContent = data.content?.[0]?.text || data.content || 'Error: Invalid response';
                
                // Add assistant message
                messages.push({ role: 'assistant', content: assistantContent });
                
            } catch (error) {
                console.error('Error:', error);
                messages.push({ 
                    role: 'assistant', 
                    content: '¬°Ups! Hubo un problema. ¬øPuedes intentar de nuevo?' 
                });
            }
            
            isLoading = false;
            renderMessages();
        }

        // ========================================
        // WELCOME MESSAGE - Auto-trigger LLM greeting
        // ========================================
        async function showWelcomeMessage() {
            messages = [];
            isLoading = true;
            renderMessages();
            
            try {
                // Call API with empty messages to trigger LLM's opening greeting
                const response = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        provider: 'openai',
                        model: 'gpt-4o',
                        max_tokens: 500,
                        system: SYSTEM_PROMPT,
                        messages: [{ role: 'user', content: '[INICIO DE CONVERSACI√ìN - Env√≠a tu saludo inicial]' }]
                    })
                });
                
                if (!response.ok) throw new Error('API request failed');
                
                const data = await response.json();
                const greeting = data.content?.[0]?.text || data.content || '¬°Hola! Soy Andrea de Tala. ¬øC√≥mo puedo ayudarte hoy?';
                
                // Add only the assistant greeting (not the system trigger)
                messages.push({ role: 'assistant', content: greeting });
                
            } catch (error) {
                console.error('Error:', error);
                messages.push({ 
                    role: 'assistant', 
                    content: '¬°Hola! Soy Andrea de Tala. üëã ¬øC√≥mo puedo ayudarte hoy?' 
                });
            }
            
            isLoading = false;
            renderMessages();
        }

        // ========================================
        // EVENT HANDLERS
        // ========================================
        
        // Login
        elements.loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = elements.usernameInput.value.trim();
            const password = elements.passwordInput.value;
            
            if (username === DEMO_CREDENTIALS.username && password === DEMO_CREDENTIALS.password) {
                isAuthenticated = true;
                elements.passwordModal.classList.add('hidden');
                showWelcomeMessage();
            } else {
                elements.loginError.textContent = 'Invalid credentials';
                elements.loginError.classList.remove('hidden');
            }
        });
        
        // Send message
        elements.messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = elements.messageInput.value.trim();
            if (text) {
                elements.messageInput.value = '';
                sendMessage(text);
            }
        });
        
        // Image upload button
        elements.imageBtn.addEventListener('click', () => {
            elements.fileInput.click();
        });
        
        // File selected
        elements.fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // Convert to base64
            const reader = new FileReader();
            reader.onload = () => {
                const base64 = reader.result;
                sendMessage('Aqu√≠ est√° mi evidencia', base64);
            };
            reader.readAsDataURL(file);
            
            // Reset file input
            elements.fileInput.value = '';
        });
        
        // Reset button
        elements.resetBtn.addEventListener('click', () => {
            if (confirm('¬øReiniciar la conversaci√≥n?')) {
                showWelcomeMessage();
            }
        });

        // ========================================
        // INIT
        // ========================================
        renderMessages();
    </script>
</body>
</html>
