<!DOCTYPE html>
<!--
    Debt Consolidation Demo - Clean Chat Agent Version
    ===================================================
    
    This version uses OpenAI API directly with a clean chat interface.
    The LLM handles the entire flow naturally through conversation.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tala - Debt Consolidation Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
        }
        .api-key-input {
            font-family: monospace;
            font-size: 0.75rem;
        }
        /* Design System Colors */
        :root {
            --orange-primary: #FF6B35;
            --orange-hover: #E55A2B;
            --light-blue: #E3F2FD;
            --blue-accent: #2196F3;
            --dark-grey: #2D2D2D;
            --light-grey-bg: #F5F5F5;
        }
        .btn-primary {
            background-color: var(--orange-primary);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--orange-hover);
        }
        .progress-bar {
            background-color: var(--light-blue);
            height: 4px;
            border-radius: 2px;
        }
        .progress-fill {
            background-color: var(--blue-accent);
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .andrea-image {
            object-fit: cover;
            object-position: center center;
            width: 100%;
            height: 100%;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'orange-primary': '#FF6B35',
                        'orange-hover': '#E55A2B',
                        'light-blue': '#E3F2FD',
                        'blue-accent': '#2196F3',
                        'dark-grey': '#2D2D2D',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4">
        <!-- Password Protection Modal -->
        <div id="passwordModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-r from-emerald-400 to-teal-500 flex items-center justify-center mx-auto mb-4 overflow-hidden">
                        <img src="images/andrea.png" alt="Andrea" class="andrea-image rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <span class="text-3xl" style="display:none;">üë©‚Äçüíº</span>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Tala Demo</h2>
                    <p class="text-sm text-gray-600">Enter your credentials to access</p>
                </div>
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label class="text-xs text-gray-500 block mb-1">Username</label>
                        <input
                            type="text"
                            id="usernameInput"
                            placeholder="Enter username"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]/20 focus:border-[#FF6B35]"
                            autocomplete="username"
                        />
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 block mb-1">Password</label>
                        <input
                            type="password"
                            id="passwordInput"
                            placeholder="Enter password"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#FF6B35]/20 focus:border-[#FF6B35]"
                            autocomplete="current-password"
                        />
                    </div>
                    <div id="loginError" class="text-red-500 text-xs text-center hidden"></div>
                    <button
                        type="submit"
                        class="w-full px-4 py-2 bg-[#FF6B35] hover:bg-[#E55A2B] text-white rounded-lg font-semibold transition-colors shadow-sm"
                    >
                        Access Demo
                    </button>
                </form>
            </div>
        </div>

        <!-- Phone Frame -->
        <div class="w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden border-8 border-gray-800 relative">
            <!-- Status Bar -->
            <div class="bg-gray-800 text-white px-6 py-2 flex justify-between items-center text-xs">
                <span>9:41</span>
                <div class="flex gap-1 items-center">
                    <div class="w-4 h-2 border border-white rounded-sm relative">
                        <div class="absolute inset-0.5 bg-white rounded-sm" style="width: 80%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-emerald-400 to-teal-500 px-4 py-4 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center overflow-hidden">
                    <img src="images/andrea.png" alt="Andrea" class="andrea-image rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="text-xl" style="display:none;">üë©‚Äçüíº</span>
                </div>
                <div class="flex-1 flex items-center gap-2">
                    <div>
                        <h1 id="title" class="text-white font-semibold text-lg tracking-tight">Tala</h1>
                        <p id="subtitle" class="text-white/90 text-xs">Tu aliado financiero</p>
                    </div>
                    <img src="https://www.tala.co/wp-content/uploads/2021/06/tala-logo-white.svg" alt="Tala Logo" class="h-5 opacity-90" onerror="this.style.display='none';">
                </div>
                <div class="flex items-center gap-2">
                    <button 
                        id="langToggle"
                        class="px-3 py-1.5 bg-white/20 hover:bg-white/30 text-white text-xs font-semibold rounded-lg transition-colors"
                    >
                        EN
                    </button>
                    <button 
                        id="resetBtn"
                        class="text-white/80 hover:text-white text-xs underline"
                    >
                        Reiniciar
                    </button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesArea" class="h-96 overflow-y-auto p-4 space-y-3 bg-white">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-100 bg-white p-3">
                <form id="messageForm" class="flex gap-2 items-end">
                    <button
                        type="button"
                        id="imageBtn"
                        class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors flex-shrink-0"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <input
                        type="file"
                        id="fileInput"
                        accept="image/*"
                        class="hidden"
                    />
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="Escribe un mensaje..."
                        class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FF6B35]/20 transition-all"
                    />
                    <button
                        type="submit"
                        id="sendBtn"
                        class="w-10 h-10 rounded-full bg-[#FF6B35] hover:bg-[#E55A2B] disabled:bg-gray-300 flex items-center justify-center text-white transition-colors flex-shrink-0"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const UI_TEXT = {
            en: {
                title: 'Andrea from Tala',
                subtitle: 'Your loan buddy',
                reset: 'Reset',
                typePlaceholder: 'Type a message...',
                langToggle: 'ES'
            },
            es: {
                title: 'Andrea de Tala',
                subtitle: 'Tu aliado financiero',
                reset: 'Reiniciar',
                typePlaceholder: 'Escribe un mensaje...',
                langToggle: 'EN'
            }
        };

        // Customer profile defaults
        const DEFAULT_PROFILE = {
            customerName: 'Mar√≠a'
        };

        // Fallback loan data based on demo screenshots (used if extraction fails)
        const FALLBACK_LOANS = [
            { lender: 'Elektra', balance: 1050, rate: 16, rateType: 'monthly', paymentFrequency: 'biweekly' },
            { lender: 'DiDi', balance: 5290.50, rate: 20, rateType: 'monthly', paymentFrequency: 'biweekly' },
            { lender: 'BBVA', balance: 2000.50, rate: 30, rateType: 'monthly', paymentFrequency: 'biweekly' }
        ];

        // Configuration - Railway backend URL (use same origin when served from backend)
        const BACKEND_URL = window.location.origin;
        
        // Demo credentials
        const DEMO_CREDENTIALS = {
            username: 'Talajote',
            password: 'StackWithT@la'
        };
        
        // State
        let messages = [];
        let language = 'es';
        let isLoading = false;
        let customerProfile = { ...DEFAULT_PROFILE };
        let isAuthenticated = false;
        let extractedLoans = []; // Track loans extracted from screenshots
        let loanExtractionAttempts = 0; // Track failed extraction attempts
        let upsellOffered = false; // Track if upsell has been offered
        let upsellAccepted = false; // Track if customer accepted the upsell

        // Build system prompt with customer info
        function buildSystemPrompt() {
            const customerInfo = language === 'es'
                ? `Nombre: ${customerProfile.customerName}`
                : `Name: ${customerProfile.customerName}`;

            const basePrompt = language === 'es' ? SYSTEM_PROMPT_ES : SYSTEM_PROMPT_EN;
            return `${basePrompt}\n\nCUSTOMER PROFILE:\n${customerInfo}\n\nIMPORTANT: When extracting loan data from images, you MUST respond with structured JSON. Track the conversation flow naturally.`;
        }

        const SYSTEM_PROMPT_EN = `You are Andrea, a friendly loan advisor at Tala. You're warm, supportive, and genuinely want to help customers manage their finances better. Think of yourself as that helpful friend at a neighborhood credit cooperative - approachable, not corporate.

CONTEXT:
- The customer has completed 5 loans successfully with Tala and has paid off their current Tala loan
- They have ALREADY OPTED IN to this special opportunity - they're interested and ready to proceed
- This is a debt consolidation product - ONE loan to replace all their OTHER loans (NOT including Tala)
- IMPORTANT: Tala loan is EXCLUDED from consolidation - customer has already paid it off

CONSOLIDATION LOAN LOGIC:
- We offer ONE consolidation loan that pays off ALL their other loans (EXCLUDING Tala - they've paid it off)
- The consolidation loan limit = total of all their OTHER outstanding loans, UP TO A MAX OF $15,000 MXN
- The consolidation loan rate = WEIGHTED AVERAGE of all their OTHER loan rates (Tala is NOT included)
- This means: if they have expensive loans elsewhere, consolidating brings their blended rate DOWN

YOUR PERSONALITY:
- Warm and conversational, like talking to a trusted neighbor
- Use casual language, contractions, even the occasional emoji when it fits naturally
- Celebrate their good payment history genuinely
- Be empathetic about the stress of managing multiple loans
- Never sound like a bank robot or use corporate jargon
- Ask one question at a time, keep messages short and digestible
- Use their name occasionally (but not every message)

FLOW TO FOLLOW (they've already opted in, so skip the pitch):
1. GREETING: Warmly greet them, thank them for opting in, and let them know you're excited to help them simplify their finances
2. EXPLAIN PROCESS: Briefly explain what you need - screenshots of their loans from other apps. They can share as many loans as they have. Keep it simple and reassuring.
3. COLLECTION: Guide them through sharing screenshots one at a time. For each screenshot they share:
   - Acknowledge it warmly
   - Analyze the image and extract loan details
   - CRITICAL: After analyzing, you MUST respond with BOTH:
     a) A friendly confirmation message (2-3 sentences) that includes the extracted details in a readable format (e.g., "Perfect! I've got this one from Elektra. Here's what I gathered: ‚Ä¢ Lender: Elektra ‚Ä¢ Balance: $2,750 MXN ‚Ä¢ Interest Rate: 6.5% weekly. Do you have any other loans you'd like to include?")
     b) A JSON object with the extracted loan data in this EXACT format (you MUST fill in the actual values from the image):
        {"loan": {"lender": "Lender Name", "balance": 1234.56, "rate": 16.0, "rateType": "monthly", "paymentFrequency": "biweekly"}}
     - IMPORTANT: The JSON must contain REAL extracted data, not empty values. Extract: lender name (e.g., Elektra, DiDi, BBVA), outstanding balance in MXN, and interest rate (convert monthly to weekly if needed).
     - IMPORTANT: If you successfully extract the data, DO NOT include any error messages. Only include error messages if you truly cannot extract the data.
   - If you cannot clearly extract the data from the image, respond with: {"loan": null, "error": "Could not extract loan details"} AND ask them to either:
     * Share another clearer screenshot that shows the lender name, outstanding balance, and interest rate
     * Or provide the details manually (lender name, balance, and interest rate)
   - If they provide loan details manually via text, extract the information and respond with the same JSON format, and ask if they have more loans
   - IMPORTANT: Competitor rates should be HIGHER (typically 6-12% weekly or 25-50% monthly)
   - IMPORTANT: After each loan, ask if they have more loans to share. Only proceed to show the offer when they indicate they're done (e.g., "that's all", "no more", "I'm done")
4. COLLECTION CONTINUES: After each loan is shared, acknowledge it warmly and ask if they have more loans to share. Keep collecting until they indicate they're done (e.g., "that's all", "no more", "I'm done", "that's everything").
5. SUMMARY: When the customer indicates they're done sharing loans, provide a brief summary of all the loans they've shared. List each loan with lender name, balance, and interest rate. Also mention the total balance and total interest they're currently paying across all loans. Keep this summary brief (3-4 sentences).
6. SUMMARY & OFFER: After your summary, the system will automatically present the consolidation offer with detailed calculations. The offer will include an additional opportunity for 10% more at the same rate. DO NOT calculate or present the offer yourself - just provide the summary and let the system show the offer.
7. UPSELL HANDLING: After the system shows the offer with the additional 10% opportunity, wait for the customer's response. If they say yes/accept, the system will show an updated offer. If they decline or don't respond clearly, acknowledge and proceed with the original offer.
8. APPROVAL: After the final offer is shown (whether with or without the additional 10%), confirm they're approved! The consolidation loan will pay off their other loans directly. One simple payment going forward.

IMPORTANT BEHAVIORS:
- When they share an image, analyze it and extract realistic loan details. Use Mexican lender names like: Elektra, DiDi, BBVA, Kueski, Stori, Nu M√©xico, Mercado Cr√©dito, Creditea, Dineria, Konf√≠o, Credilikeme, Moneyman, or Cashclick
- CRITICAL: After extracting loan data from an image, ALWAYS include a JSON object in your response with the structured data
- Keep responses SHORT - 2-3 sentences max usually
- They already opted in, so don't re-pitch or ask if they're interested - they ARE
- If they seem hesitant about sharing, be reassuring about privacy/security
- ALWAYS respond in English
- Remember: max consolidation limit is $15,000 MXN even if their total debt is higher
- Remember: Tala loan is EXCLUDED - customer has paid it off

CURRENCY: Always use Mexican pesos (MXN) with $ symbol, e.g., $5,000 MXN`;

        const SYSTEM_PROMPT_ES = `Eres Andrea, una asesora de pr√©stamos amigable en Tala. Eres c√°lida, comprensiva y genuinamente quieres ayudar a los clientes a manejar mejor sus finanzas. Piensa en ti misma como esa amiga servicial de una cooperativa de cr√©dito del barrio - accesible, no corporativa.

CONTEXTO:
- El cliente ha completado 5 pr√©stamos exitosamente con Tala y ya pag√≥ su pr√©stamo actual de Tala
- YA ACEPTARON participar en esta oportunidad especial - est√°n interesados y listos para continuar
- Este es un producto de consolidaci√≥n de deudas - UN pr√©stamo para reemplazar todos sus OTROS pr√©stamos (NO incluyendo Tala)
- IMPORTANTE: El pr√©stamo de Tala est√° EXCLUIDO de la consolidaci√≥n - el cliente ya lo pag√≥

L√ìGICA DEL PR√âSTAMO DE CONSOLIDACI√ìN:
- Ofrecemos UN pr√©stamo de consolidaci√≥n que paga TODOS sus otros pr√©stamos (EXCLUYENDO Tala - ya lo pagaron)
- L√≠mite del pr√©stamo de consolidaci√≥n = total de todos sus OTROS pr√©stamos pendientes, HASTA UN M√ÅXIMO DE $15,000 MXN
- Tasa del pr√©stamo de consolidaci√≥n = PROMEDIO PONDERADO de todas sus OTRAS tasas (Tala NO est√° incluida)
- Si tienen pr√©stamos caros en otros lados, consolidar baja su tasa combinada

TU PERSONALIDAD:
- C√°lida y conversacional, como hablar con un vecino de confianza
- Usa lenguaje casual, coloquial mexicano natural, emojis ocasionales cuando encajen
- Celebra genuinamente su buen historial de pagos
- Nunca suenes como un robot bancario ni uses jerga corporativa
- Haz una pregunta a la vez, mant√©n los mensajes cortos (2-3 oraciones usualmente)
- Usa su nombre ocasionalmente (pero no en cada mensaje)
- Usa "t√∫" no "usted" - queremos un tono cercano

FLUJO DE CONVERSACI√ìN:
1. SALUDO: Sal√∫dalos calurosamente, agrad√©celes por aceptar. Ya aceptaron participar - salta el pitch.
2. EXPLICAR PROCESO: Explica brevemente que necesitas detalles de sus pr√©stamos de otras apps. Pueden compartir tantos pr√©stamos como tengan. Pueden compartir capturas o decirte los detalles.
3. RECOLECCI√ìN: Gu√≠alos para compartir detalles de pr√©stamos uno por uno. Por cada captura que compartan:
   - Reconoce calurosamente
   - Analiza la imagen y extrae los detalles del pr√©stamo
   - CR√çTICO: Despu√©s de analizar, DEBES responder con AMBOS:
     a) Un mensaje amigable de confirmaci√≥n (2-3 oraciones) que incluya los detalles extra√≠dos en un formato legible (ej: "¬°Perfecto! Ya tengo este de Elektra. Esto es lo que encontr√©: ‚Ä¢ Prestamista: Elektra ‚Ä¢ Saldo: $2,750 MXN ‚Ä¢ Tasa de Inter√©s: 6.5% semanal. ¬øTienes otros pr√©stamos que quieras incluir?")
     b) Un objeto JSON con los datos extra√≠dos del pr√©stamo en este formato EXACTO (DEBES llenar los valores reales de la imagen):
        {"loan": {"lender": "Nombre del Prestamista", "balance": 1234.56, "rate": 16.0, "rateType": "monthly", "paymentFrequency": "biweekly"}}
     - IMPORTANTE: El JSON debe contener datos REALES extra√≠dos, no valores vac√≠os. Extrae: nombre del prestamista (ej., Elektra, DiDi, BBVA), saldo pendiente en MXN, y tasa de inter√©s (convierte mensual a semanal si es necesario).
     - IMPORTANTE: Si extraes los datos exitosamente, NO incluyas ning√∫n mensaje de error. Solo incluye mensajes de error si realmente no puedes extraer los datos.
   - Si no puedes extraer claramente los datos de la imagen, responde con: {"loan": null, "error": "No se pudieron extraer los detalles del pr√©stamo"} Y p√≠deles que:
     * Compartan otra captura m√°s clara que muestre el nombre del prestamista, saldo pendiente y tasa de inter√©s
     * O que te den los detalles manualmente (nombre del prestamista, saldo y tasa de inter√©s)
   - Si te proporcionan los detalles del pr√©stamo manualmente por texto, extrae la informaci√≥n y responde con el mismo formato JSON, y pregunta si tienen m√°s pr√©stamos
   - IMPORTANTE: Las tasas de competidores deben ser M√ÅS ALTAS (t√≠picamente 6-12% semanal o 25-50% mensual)
   - IMPORTANTE: Despu√©s de cada pr√©stamo, pregunta si tienen m√°s pr√©stamos para compartir. Solo procede a mostrar la oferta cuando indiquen que terminaron (ej., "eso es todo", "no m√°s", "ya termin√©")
4. RECOLECCI√ìN CONTIN√öA: Despu√©s de cada pr√©stamo compartido, recon√≥celo calurosamente y pregunta si tienen m√°s pr√©stamos para compartir. Sigue recolectando hasta que indiquen que terminaron (ej., "eso es todo", "no m√°s", "ya termin√©", "eso es todo lo que tengo").
5. RESUMEN: Cuando el cliente indique que termin√≥ de compartir pr√©stamos, proporciona un breve resumen de todos los pr√©stamos que compartieron. Lista cada pr√©stamo con nombre del prestamista, saldo y tasa de inter√©s. Tambi√©n menciona el saldo total y el inter√©s total que est√°n pagando actualmente en todos los pr√©stamos. Mant√©n este resumen breve (3-4 oraciones).
6. RESUMEN Y OFERTA: Despu√©s de tu resumen, el sistema presentar√° autom√°ticamente la oferta de consolidaci√≥n con c√°lculos detallados. NO calcules ni presentes la oferta t√∫ misma - solo proporciona el resumen y deja que el sistema muestre la oferta.
7. APROBACI√ìN: Despu√©s de que el sistema muestre la oferta, ¬°confirma que est√°n aprobados! El pr√©stamo de consolidaci√≥n pagar√° sus otros pr√©stamos directamente.

COMPORTAMIENTOS IMPORTANTES:
- Cuando compartan una imagen, anal√≠zala y extrae detalles realistas del pr√©stamo. Usa nombres de prestamistas mexicanos como: Elektra, DiDi, BBVA, Kueski, Stori, Nu M√©xico, Mercado Cr√©dito, Creditea, Dineria, Konf√≠o, Credilikeme, Moneyman, o Cashclick
- CR√çTICO: Despu√©s de extraer datos de un pr√©stamo de una imagen, SIEMPRE incluye un objeto JSON en tu respuesta con los datos estructurados
- Mant√©n las respuestas CORTAS - 2-3 oraciones m√°ximo usualmente
- Ya aceptaron participar, as√≠ que no vuelvas a hacer pitch ni preguntes si est√°n interesados
- Si parecen dudosos, s√© tranquilizadora sobre privacidad/seguridad
- SIEMPRE responde en espa√±ol mexicano natural
- Recuerda: el l√≠mite m√°ximo de consolidaci√≥n es $15,000 MXN aunque su deuda total sea mayor
- Recuerda: El pr√©stamo de Tala est√° EXCLUIDO - el cliente ya lo pag√≥

MONEDA: Siempre usa pesos mexicanos (MXN) con s√≠mbolo $, ej., $5,000 MXN`;

        // DOM elements
        const elements = {
            messagesArea: document.getElementById('messagesArea'),
            messageInput: document.getElementById('messageInput'),
            messageForm: document.getElementById('messageForm'),
            fileInput: document.getElementById('fileInput'),
            imageBtn: document.getElementById('imageBtn'),
            sendBtn: document.getElementById('sendBtn'),
            resetBtn: document.getElementById('resetBtn'),
            langToggle: document.getElementById('langToggle'),
            title: document.getElementById('title'),
            subtitle: document.getElementById('subtitle')
        };

        // Check authentication
        checkAuthentication();

        // Format message text with simple markdown support
        function formatMessage(text) {
            if (!text) return '';
            
            // Escape HTML first
            let html = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            // Headers (### Header -> <strong>Header</strong>)
            html = html.replace(/###\s+(.+)/g, '<div class="font-bold text-base mt-2 mb-1">$1</div>');
            html = html.replace(/##\s+(.+)/g, '<div class="font-bold text-base mt-2 mb-1">$1</div>');
            html = html.replace(/#\s+(.+)/g, '<div class="font-bold text-base mt-2 mb-1">$1</div>');
            
            // Bold (**text** or __text__)
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold">$1</strong>');
            html = html.replace(/__(.+?)__/g, '<strong class="font-semibold">$1</strong>');
            
            // Bullet lists (- item)
            html = html.replace(/^-\s+(.+)$/gm, '<div class="ml-2 mb-1">‚Ä¢ $1</div>');
            
            // Numbered lists (1. item)
            html = html.replace(/^\d+\.\s+(.+)$/gm, '<div class="ml-2 mb-1">$1</div>');
            
            // Line breaks
            html = html.replace(/\n/g, '<br>');
            
            return html;
        }

        // Update UI text based on language
        function updateUIText() {
            const t = UI_TEXT[language];
            elements.title.textContent = t.title;
            elements.subtitle.textContent = t.subtitle;
            elements.resetBtn.textContent = t.reset;
            elements.messageInput.placeholder = t.typePlaceholder;
            elements.langToggle.textContent = t.langToggle;
        }

        // Extract JSON from agent response, with fallback to text parsing
        function extractLoanData(text) {
            try {
                // Try to find JSON object in the response - look for loan object
                const jsonMatch = text.match(/\{[\s\S]*?"loan"[\s\S]*?\}/);
                if (jsonMatch) {
                    const parsed = JSON.parse(jsonMatch[0]);
                    // Check if loan data is actually present and valid
                    if (parsed.loan && parsed.loan.lender && parsed.loan.balance && parsed.loan.rate) {
                        return parsed.loan;
                    }
                }
                // Also try to find JSON code blocks
                const codeBlockMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
                if (codeBlockMatch) {
                    const parsed = JSON.parse(codeBlockMatch[1]);
                    if (parsed.loan && parsed.loan.lender && parsed.loan.balance && parsed.loan.rate) {
                        return parsed.loan;
                    }
                }
                
                // Fallback: Try to extract from text format if JSON not found
                // Look for patterns like "Lender: Kueski" or "‚Ä¢ Lender: Kueski" or "Lender: Elektra"
                // Handle both bullet points and plain text
                const lenderPatterns = [
                    /(?:Lender|Prestador|Prestamista):\s*([A-Za-z\s]+(?:M√©xico|Pago|Cr√©dito|Pago)?)/i,
                    /‚Ä¢\s*(?:Lender|Prestador|Prestamista):\s*([A-Za-z\s]+(?:M√©xico|Pago|Cr√©dito|Pago)?)/i
                ];
                
                const balancePatterns = [
                    /(?:Balance|Saldo):\s*\$?([\d,]+\.?\d*)\s*MXN/i,
                    /‚Ä¢\s*(?:Balance|Saldo):\s*\$?([\d,]+\.?\d*)\s*MXN/i
                ];
                
                const ratePatterns = [
                    /(?:Interest Rate|Tasa|Tasa de Inter√©s):\s*([\d.]+)%\s*(weekly|semanal|monthly|mensual)/i,
                    /‚Ä¢\s*(?:Interest Rate|Tasa|Tasa de Inter√©s):\s*([\d.]+)%\s*(weekly|semanal|monthly|mensual)/i
                ];
                
                let lenderMatch = null;
                let balanceMatch = null;
                let rateMatch = null;
                
                // Try each pattern
                for (const pattern of lenderPatterns) {
                    lenderMatch = text.match(pattern);
                    if (lenderMatch) break;
                }
                
                for (const pattern of balancePatterns) {
                    balanceMatch = text.match(pattern);
                    if (balanceMatch) break;
                }
                
                for (const pattern of ratePatterns) {
                    rateMatch = text.match(pattern);
                    if (rateMatch) break;
                }
                
                if (lenderMatch && balanceMatch && rateMatch) {
                    const lender = lenderMatch[1].trim();
                    const balance = parseFloat(balanceMatch[1].replace(/,/g, ''));
                    const rate = parseFloat(rateMatch[1]);
                    const rateType = rateMatch[2].toLowerCase().includes('monthly') || rateMatch[2].toLowerCase().includes('mensual') ? 'monthly' : 'weekly';
                    
                    if (lender && balance && rate && !isNaN(balance) && !isNaN(rate)) {
                        return {
                            lender: lender,
                            balance: balance,
                            rate: rate,
                            rateType: rateType,
                            paymentFrequency: 'biweekly'
                        };
                    }
                }
            } catch (e) {
                console.warn('Failed to parse loan data from response:', e);
            }
            return null;
        }

        // Try to extract loan details from manual text input
        function extractLoanFromText(text) {
            // This is a simple pattern matcher - the agent should handle this better
            // But we can try to extract if user provides structured info
            const lenderMatch = text.match(/(?:lender|prestamista|banco|app):\s*([A-Za-z\s]+)/i);
            const balanceMatch = text.match(/(?:balance|saldo|monto):\s*\$?([\d,]+\.?\d*)/i);
            const rateMatch = text.match(/(?:rate|tasa|inter√©s):\s*([\d.]+)%/i);
            
            if (lenderMatch && balanceMatch && rateMatch) {
                return {
                    lender: lenderMatch[1].trim(),
                    balance: parseFloat(balanceMatch[1].replace(/,/g, '')),
                    rate: parseFloat(rateMatch[1]),
                    rateType: text.toLowerCase().includes('mensual') || text.toLowerCase().includes('monthly') ? 'monthly' : 'weekly',
                    paymentFrequency: 'biweekly' // Default
                };
            }
            return null;
        }

        // Convert monthly rate to weekly rate
        function monthlyToWeekly(monthlyRate) {
            return monthlyRate / 4.33; // Approximate weeks per month
        }

        // Calculate weighted average rate (all rates converted to weekly)
        function calculateWeightedAverageRate(loans) {
            if (loans.length === 0) return 0;
            
            let totalWeightedRate = 0;
            let totalBalance = 0;
            
            loans.forEach(loan => {
                const weeklyRate = loan.rateType === 'monthly' 
                    ? monthlyToWeekly(loan.rate) 
                    : loan.rate;
                totalWeightedRate += loan.balance * weeklyRate;
                totalBalance += loan.balance;
            });
            
            return totalBalance > 0 ? totalWeightedRate / totalBalance : 0;
        }

        // Calculate amortized weekly payment
        function calculateAmortizedWeeklyPayment(principal, weeklyRatePercent, numWeeks) {
            const r = weeklyRatePercent / 100; // Convert to decimal
            if (r === 0) return principal / numWeeks; // No interest case
            
            const numerator = r * Math.pow(1 + r, numWeeks);
            const denominator = Math.pow(1 + r, numWeeks) - 1;
            return principal * (numerator / denominator);
        }

        // Calculate weekly rate needed to achieve target monthly payment (8 month term, amortized)
        function calculateRateForTargetPayment(principal, targetMonthlyPayment, numMonths = 8) {
            const numWeeks = numMonths * 4.33; // 8 months = ~34.64 weeks
            const targetWeeklyPayment = targetMonthlyPayment / 4.33;
            
            // Binary search for the rate
            let low = 0;
            let high = 20; // Max 20% weekly rate
            let bestRate = 0;
            const tolerance = 0.01; // 0.01% precision
            
            while (high - low > tolerance) {
                const mid = (low + high) / 2;
                const weeklyPayment = calculateAmortizedWeeklyPayment(principal, mid, numWeeks);
                
                if (weeklyPayment <= targetWeeklyPayment) {
                    bestRate = mid;
                    high = mid;
                } else {
                    low = mid;
                }
            }
            
            return bestRate;
        }

        // Calculate current total monthly payment across all loans (amortized estimate)
        function calculateCurrentMonthlyPayment(loans) {
            return loans.reduce((sum, loan) => {
                // Estimate monthly payment using amortization
                // Assume 3 month term for existing loans (typical short-term loans)
                const numWeeks = 3 * 4.33; // ~13 weeks
                
                if (loan.rateType === 'monthly') {
                    const weeklyRate = monthlyToWeekly(loan.rate);
                    const weeklyPayment = calculateAmortizedWeeklyPayment(loan.balance, weeklyRate, numWeeks);
                    return sum + (weeklyPayment * 4.33); // Convert to monthly
                } else {
                    const weeklyPayment = calculateAmortizedWeeklyPayment(loan.balance, loan.rate, numWeeks);
                    return sum + (weeklyPayment * 4.33); // Convert to monthly
                }
            }, 0);
        }

        // Calculate consolidation offer (8 month term, amortized, 20% payment reduction)
        function calculateConsolidationOffer(loans, includeAdditional10Percent = false) {
            if (loans.length === 0) return null;
            
            const baseBalance = Math.min(
                loans.reduce((sum, loan) => sum + loan.balance, 0),
                15000 // Max consolidation limit
            );
            
            // Add 10% if requested
            const totalBalance = includeAdditional10Percent 
                ? Math.min(baseBalance * 1.1, 15000) 
                : baseBalance;
            
            const numMonths = 8;
            const numWeeks = numMonths * 4.33; // ~34.64 weeks
            
            // Calculate current total monthly payment
            const currentMonthlyPayment = calculateCurrentMonthlyPayment(loans);
            
            // Target: 20% reduction in monthly payment
            const targetMonthlyPayment = currentMonthlyPayment * 0.8;
            
            // Calculate weekly rate needed to achieve target payment (amortized over 8 months)
            const weeklyRate = calculateRateForTargetPayment(totalBalance, targetMonthlyPayment, numMonths);
            
            // Calculate new weekly and monthly payments
            const newWeeklyPayment = calculateAmortizedWeeklyPayment(totalBalance, weeklyRate, numWeeks);
            const newMonthlyPayment = newWeeklyPayment * 4.33;
            
            // Calculate current total weekly interest (simple interest estimate)
            const currentWeeklyInterest = loans.reduce((sum, loan) => {
                const weeklyRate = loan.rateType === 'monthly' 
                    ? monthlyToWeekly(loan.rate) 
                    : loan.rate;
                return sum + (loan.balance * weeklyRate / 100);
            }, 0);
            
            // Calculate new weekly interest (first week, will decrease over time with amortization)
            const newWeeklyInterest = totalBalance * weeklyRate / 100;
            
            // Calculate monthly interest
            const currentMonthlyInterest = currentWeeklyInterest * 4.33;
            const newMonthlyInterest = newWeeklyInterest * 4.33;
            const monthlyInterestSavings = currentMonthlyInterest - newMonthlyInterest;
            
            // Calculate total interest over 8 months
            // Total paid = monthly payment * 8 months
            const totalPaidCurrent = currentMonthlyPayment * numMonths;
            const totalPaidNew = newMonthlyPayment * numMonths;
            const totalInterestCurrent = totalPaidCurrent - baseBalance;
            const totalInterestNew = totalPaidNew - totalBalance;
            const totalInterestSavings = totalInterestCurrent - totalInterestNew;
            
            // Calculate payment savings
            const monthlyPaymentSavings = currentMonthlyPayment - newMonthlyPayment;
            const totalPaymentSavings = monthlyPaymentSavings * numMonths;
            
            // Get weighted average for comparison
            const weightedRate = calculateWeightedAverageRate(loans);
            
            return {
                totalBalance,
                baseBalance,
                weeklyRate,
                weightedRate, // For comparison
                numMonths,
                numWeeks,
                currentMonthlyPayment,
                newMonthlyPayment,
                monthlyPaymentSavings,
                totalPaymentSavings,
                currentMonthlyInterest,
                newMonthlyInterest,
                monthlyInterestSavings,
                totalInterestCurrent,
                totalInterestNew,
                totalInterestSavings,
                includeAdditional10Percent,
                additionalAmount: includeAdditional10Percent ? (totalBalance - baseBalance) : 0
            };
        }

        // Calculate payment dates
        function calculatePaymentDates(numMonths) {
            const today = new Date();
            const firstPaymentDate = new Date(today);
            firstPaymentDate.setMonth(firstPaymentDate.getMonth() + 1);
            firstPaymentDate.setDate(15); // Set to 15th of next month
            
            const dueDate = new Date(firstPaymentDate);
            
            const formatDate = (date) => {
                const months = language === 'es' 
                    ? ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic']
                    : ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
            };
            
            return {
                firstPayment: formatDate(firstPaymentDate),
                dueDate: formatDate(dueDate)
            };
        }

        // Format consolidation offer message
        function formatConsolidationOffer(loans, offer, showUpsell = false) {
            const paymentDates = calculatePaymentDates(offer.numMonths);
            const numPayments = offer.numMonths;
            
            if (language === 'es') {
                let message = `**Oferta de Consolidaci√≥n**\n\n`;
                message += `**Tus pr√©stamos actuales:**\n`;
                loans.forEach(loan => {
                    const rateDisplay = loan.rateType === 'monthly' 
                        ? `${loan.rate}% mensual` 
                        : `${loan.rate}% semanal`;
                    message += `‚Ä¢ ${loan.lender}: $${loan.balance.toLocaleString()} MXN a ${rateDisplay}\n`;
                });
                message += `\n**Tu situaci√≥n actual:**\n`;
                message += `‚Ä¢ **Saldo total:** $${offer.baseBalance.toLocaleString()} MXN\n`;
                message += `‚Ä¢ **Pago mensual actual:** $${offer.currentMonthlyPayment.toFixed(2)} MXN\n`;
                message += `‚Ä¢ **Inter√©s mensual actual:** $${offer.currentMonthlyInterest.toFixed(2)} MXN\n`;
                message += `‚Ä¢ **Tasa promedio actual:** ${offer.weightedRate.toFixed(2)}% semanal\n`;
                message += `\n**Tu nueva oferta de consolidaci√≥n:**\n`;
                if (offer.includeAdditional10Percent) {
                    message += `‚Ä¢ **Monto total del pr√©stamo:** $${offer.totalBalance.toLocaleString()} MXN (incluye $${offer.additionalAmount.toFixed(2)} adicionales)\n`;
                } else {
                    message += `‚Ä¢ **Monto total del pr√©stamo:** $${offer.totalBalance.toLocaleString()} MXN\n`;
                }
                message += `‚Ä¢ **Tasa de inter√©s semanal:** ${offer.weeklyRate.toFixed(2)}% semanal (m√°s baja que tu promedio actual)\n`;
                message += `‚Ä¢ **Monto del pago mensual:** $${offer.newMonthlyPayment.toFixed(2)} MXN\n`;
                message += `‚Ä¢ **N√∫mero de pagos:** ${numPayments} pagos mensuales\n`;
                message += `‚Ä¢ **Fecha del primer pago:** ${paymentDates.firstPayment}\n`;
                message += `‚Ä¢ **Fecha de vencimiento:** ${paymentDates.dueDate}\n`;
                message += `\n**¬°Tus ahorros:**\n`;
                message += `‚Ä¢ **Ahorro en pago mensual:** $${offer.monthlyPaymentSavings.toFixed(2)} MXN (${((offer.monthlyPaymentSavings / offer.currentMonthlyPayment) * 100).toFixed(1)}% menos)\n`;
                message += `‚Ä¢ **Ahorro en inter√©s mensual:** $${offer.monthlyInterestSavings.toFixed(2)} MXN\n`;
                message += `‚Ä¢ **Ahorro total en intereses (${offer.numMonths} meses):** $${offer.totalInterestSavings.toFixed(2)} MXN\n`;
                message += `‚Ä¢ **Ahorro total en pagos (${offer.numMonths} meses):** $${offer.totalPaymentSavings.toFixed(2)} MXN\n\n`;
                message += `En vez de estar batallando con ${loans.length} pagos diferentes ($${offer.currentMonthlyPayment.toFixed(2)}/mes), ahora tienes **UN solo pago** de $${offer.newMonthlyPayment.toFixed(2)}/mes.\n\n`;
                
                if (!showUpsell && !offer.includeAdditional10Percent) {
                    message += `**Oportunidad adicional:**\n`;
                    const additionalAmount = Math.min(offer.baseBalance * 0.1, 15000 - offer.baseBalance);
                    message += `¬øTe gustar√≠a recibir un 10% adicional ($${additionalAmount.toFixed(2)} MXN) al mismo tipo de inter√©s? Esto puede ayudarte a cubrir gastos inesperados y mantenerte alejado de otros prestamistas.\n\n`;
                } else {
                    message += `¬°Est√°s aprobada! El pr√©stamo de consolidaci√≥n pagar√° tus otros pr√©stamos directamente. Un solo pago simple de aqu√≠ en adelante.`;
                }
                return message;
            } else {
                let message = `**Consolidation Offer**\n\n`;
                message += `**Your current loans:**\n`;
                loans.forEach(loan => {
                    const rateDisplay = loan.rateType === 'monthly' 
                        ? `${loan.rate}% monthly` 
                        : `${loan.rate}% weekly`;
                    message += `‚Ä¢ ${loan.lender}: $${loan.balance.toLocaleString()} MXN at ${rateDisplay}\n`;
                });
                message += `\n**Your current situation:**\n`;
                message += `‚Ä¢ **Total balance:** $${offer.baseBalance.toLocaleString()} MXN\n`;
                message += `‚Ä¢ **Current monthly payment:** $${offer.currentMonthlyPayment.toFixed(2)} MXN\n`;
                message += `‚Ä¢ **Current monthly interest:** $${offer.currentMonthlyInterest.toFixed(2)} MXN\n`;
                message += `‚Ä¢ **Current average rate:** ${offer.weightedRate.toFixed(2)}% weekly\n`;
                message += `\n**Your new consolidation offer:**\n`;
                if (offer.includeAdditional10Percent) {
                    message += `‚Ä¢ **Total loan amount:** $${offer.totalBalance.toLocaleString()} MXN (includes $${offer.additionalAmount.toFixed(2)} additional)\n`;
                } else {
                    message += `‚Ä¢ **Total loan amount:** $${offer.totalBalance.toLocaleString()} MXN\n`;
                }
                message += `‚Ä¢ **Weekly interest rate:** ${offer.weeklyRate.toFixed(2)}% weekly (lower than your current average)\n`;
                message += `‚Ä¢ **Monthly payment amount:** $${offer.newMonthlyPayment.toFixed(2)} MXN\n`;
                message += `‚Ä¢ **Number of payments:** ${numPayments} monthly payments\n`;
                message += `‚Ä¢ **Date of first payment:** ${paymentDates.firstPayment}\n`;
                message += `‚Ä¢ **Due date:** ${paymentDates.dueDate}\n`;
                message += `\n**Your savings:**\n`;
                message += `‚Ä¢ **Monthly payment savings:** $${offer.monthlyPaymentSavings.toFixed(2)} MXN (${((offer.monthlyPaymentSavings / offer.currentMonthlyPayment) * 100).toFixed(1)}% less)\n`;
                message += `‚Ä¢ **Monthly interest savings:** $${offer.monthlyInterestSavings.toFixed(2)} MXN\n`;
                message += `‚Ä¢ **Total interest savings (${offer.numMonths} months):** $${offer.totalInterestSavings.toFixed(2)} MXN\n`;
                message += `‚Ä¢ **Total payment savings (${offer.numMonths} months):** $${offer.totalPaymentSavings.toFixed(2)} MXN\n\n`;
                message += `Instead of juggling ${loans.length} different payments ($${offer.currentMonthlyPayment.toFixed(2)}/month), you now have **ONE payment** of $${offer.newMonthlyPayment.toFixed(2)}/month.\n\n`;
                
                if (!showUpsell && !offer.includeAdditional10Percent) {
                    message += `**Additional opportunity:**\n`;
                    const additionalAmount = Math.min(offer.baseBalance * 0.1, 15000 - offer.baseBalance);
                    message += `Would you like an additional 10% ($${additionalAmount.toFixed(2)} MXN) at the same interest rate? This can help cover unexpected expenses and keep you from needing other lenders.\n\n`;
                } else {
                    message += `You're approved! The consolidation loan will pay off your other loans directly. One simple payment going forward.`;
                }
                return message;
            }
        }

        // Use fallback loan if extraction fails
        function useFallbackLoan(attemptIndex) {
            if (attemptIndex < FALLBACK_LOANS.length) {
                return { ...FALLBACK_LOANS[attemptIndex] };
            }
            return null;
        }

        // Check if customer indicates they're done sharing loans
        function isDoneSharingLoans(text) {
            if (!text) return false;
            const lowerText = text.toLowerCase();
            const donePhrases = [
                'that\'s all', 'thats all', 'that is all',
                'no more', 'no more loans', 'no more to share',
                'i\'m done', 'im done', 'i am done', 'done',
                'that\'s everything', 'thats everything', 'that is everything',
                'finished', 'i\'m finished', 'im finished',
                'all done', 'all set', 'ready to see',
                'show me the offer', 'show the offer', 'ready for offer',
                'eso es todo', 'no m√°s', 'ya termin√©', 'termin√©',
                'listo', 'listo para ver', 'mu√©strame la oferta'
            ];
            return donePhrases.some(phrase => lowerText.includes(phrase));
        }

        // Render messages
        function renderMessages() {
            elements.messagesArea.innerHTML = '';
            
            messages.forEach((msg) => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = `max-w-xs ${msg.role === 'user' ? 'order-2' : ''}`;
                
                if (msg.image) {
                    const imgDiv = document.createElement('div');
            imgDiv.className = 'mb-2 rounded-xl overflow-hidden border-2 border-gray-200 bg-gray-100';
                    const img = document.createElement('img');
                    img.src = msg.image;
                    img.alt = 'Uploaded loan screenshot';
                    img.className = 'w-full max-w-xs object-contain';
                    img.style.maxHeight = '400px';
                    imgDiv.appendChild(img);
                    contentDiv.appendChild(imgDiv);
                }
                
                const textDiv = document.createElement('div');
                textDiv.className = `px-4 py-2.5 rounded-2xl text-sm leading-relaxed ${
                    msg.role === 'user' 
                        ? 'bg-[#FF6B35] text-white rounded-br-md shadow-sm' 
                        : 'bg-white text-gray-700 rounded-bl-md shadow-sm border border-gray-100'
                }`;
                
                // Simple markdown rendering for assistant messages
                if (msg.role === 'assistant') {
                    textDiv.innerHTML = formatMessage(msg.content);
                } else {
                    textDiv.textContent = msg.content;
                }
                
                contentDiv.appendChild(textDiv);
                
                msgDiv.appendChild(contentDiv);
                elements.messagesArea.appendChild(msgDiv);
            });
            
            if (isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="bg-white px-4 py-3 rounded-2xl rounded-bl-md shadow-sm border border-gray-100">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-[#FF6B35] rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                            <div class="w-2 h-2 bg-[#FF6B35] rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                            <div class="w-2 h-2 bg-[#FF6B35] rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                        </div>
                    </div>
                `;
                elements.messagesArea.appendChild(loadingDiv);
            }
            
            elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
        }

        // Welcome messages
        function getWelcomeMessage() {
            const name = customerProfile.customerName;
            if (language === 'es') {
                return `¬°Hola ${name}! üëã Qu√© gusto que aceptaste esta oportunidad. Soy Andrea de Tala, y estoy aqu√≠ para ayudarte a consolidar todos tus pr√©stamos en uno solo.

En los pr√≥ximos minutos, vamos a revisar tus pr√©stamos de otras apps y te voy a mostrar c√≥mo puedes simplificar todo en un solo pago, con una tasa m√°s baja y menos estr√©s.

¬øLista para empezar? Solo necesito que compartas las capturas de tus pr√©stamos con otras apps. Puedes compartir tantos como tengas.`;
            } else {
                return `Hey ${name}! üëã So glad you opted in for this opportunity. I'm Andrea from Tala, and I'm here to help you consolidate all your loans into one.

Over the next few minutes, we'll review your loans from other apps and I'll show you how you can simplify everything into one payment, with a lower rate and less stress.

Ready to get started? I just need you to share screenshots of your loans with other apps. You can share as many as you have.`;
            }
        }

        // Start conversation
        async function startConversation() {
            isLoading = true;
            renderMessages();

            // Use hardcoded welcome message
            const welcomeMessage = getWelcomeMessage();

            messages = [{ role: 'assistant', content: welcomeMessage }];
            isLoading = false;
            renderMessages();
        }

        // Send message with structured data extraction
        async function sendMessage(userMessage, imageData = null) {
            if (!userMessage.trim() && !imageData) return;

            // Add user message
            const userMsg = { 
                role: 'user', 
                content: userMessage || (imageData ? (language === 'es' ? 'Aqu√≠ est√° mi captura del pr√©stamo' : 'Here\'s my loan screenshot') : ''),
                image: imageData 
            };
            messages.push(userMsg);
            elements.messageInput.value = '';
            isLoading = true;
            renderMessages();

            // Build messages for backend API
            const systemPrompt = buildSystemPrompt();
            const apiMessages = messages.map(msg => {
                if (msg.role === 'user' && msg.image) {
                    // For images, use vision API format
                    return {
                        role: 'user',
                        content: [
                            {
                                type: 'text',
                                text: msg.content || (language === 'es' 
                                    ? 'Estoy compartiendo una captura de un pr√©stamo. Por favor anal√≠zala y extrae el nombre del prestamista, saldo pendiente y tasa de inter√©s.'
                                    : 'I\'m sharing a loan screenshot. Please analyze it and extract the lender name, outstanding balance, and interest rate.')
                            },
                            {
                                type: 'image_url',
                                image_url: {
                                    url: msg.image
                                }
                            }
                        ]
                    };
                }
                return { role: msg.role, content: msg.content };
            });

            try {
                const response = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: 'openai',
                        model: 'gpt-4o',
                        max_tokens: 500,
                        system: systemPrompt,
                        messages: apiMessages,
                        sessionId: `debt-consolidation-${Date.now()}`,
                        userId: customerProfile.customerName
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'API request failed');
                }

                const data = await response.json();
                // Backend returns normalized format: { content: [{ text: "..." }] }
                let assistantMessage = data.content?.[0]?.text || data.content || 'Error: Invalid response';
                
                // If this was an image upload, try to extract structured loan data
                if (imageData) {
                    const extractedLoan = extractLoanData(assistantMessage);
                    
                    if (extractedLoan && extractedLoan.lender && extractedLoan.balance && extractedLoan.rate) {
                        // Successfully extracted loan data
                        extractedLoans.push(extractedLoan);
                        loanExtractionAttempts = 0; // Reset fallback counter
                        
                        // Remove JSON from the displayed message (keep only the friendly text)
                        // The LLM should handle all messaging, we just clean up the JSON
                        assistantMessage = assistantMessage
                            .replace(/\{[\s\S]*?"loan"[\s\S]*?\}/g, '')
                            .replace(/```json\s*[\s\S]*?\s*```/g, '')
                            .replace(/```\s*\{[\s\S]*?\}\s*```/g, '')
                            .replace(/\{\s*\}/g, '') // Remove empty JSON objects
                            .replace(/\n\n\n+/g, '\n\n') // Clean up multiple newlines
                            .trim();
                        
                        // Just acknowledge the loan - don't show offer yet
                        // The agent will ask if they have more loans, and only show offer when customer says they're done
                messages.push({ role: 'assistant', content: assistantMessage });
                    } else {
                        // Extraction failed - ask customer for manual details or better photo
                        loanExtractionAttempts++;
                        const errorMsg = language === 'es'
                            ? 'No pude extraer claramente los detalles del pr√©stamo de esta imagen. ¬øPodr√≠as ayudarme de una de estas formas?\n\n1. Compartir otra captura m√°s clara que muestre el nombre del prestamista, saldo pendiente y tasa de inter√©s\n2. O decirme los detalles manualmente: nombre del prestamista, saldo pendiente y tasa de inter√©s'
                            : 'I couldn\'t clearly extract the loan details from this image. Could you help me in one of these ways?\n\n1. Share another clearer screenshot that shows the lender name, outstanding balance, and interest rate\n2. Or tell me the details manually: lender name, outstanding balance, and interest rate';
                        
                        // Update the assistant message to include the error message
                        // Remove JSON (including empty ones) and code blocks
                        assistantMessage = assistantMessage
                            .replace(/\{[\s\S]*?"loan"[\s\S]*?\}/g, '')
                            .replace(/```json\s*[\s\S]*?\s*```/g, '')
                            .replace(/```\s*\{[\s\S]*?\}\s*```/g, '')
                            .replace(/\{\s*\}/g, '') // Remove empty JSON objects
                            .trim();
                        if (assistantMessage) {
                            assistantMessage += '\n\n' + errorMsg;
                        } else {
                            assistantMessage = errorMsg;
                        }
                        messages.push({ role: 'assistant', content: assistantMessage });
                    }
                } else {
                    // Regular text message - check if user is providing manual loan details or indicating they're done
                    if (userMessage) {
                        // First check if they're indicating they're done sharing loans
                        if (isDoneSharingLoans(userMessage) && extractedLoans.length >= 1) {
                            // Customer is done - show consolidation offer
                            const offer = calculateConsolidationOffer(extractedLoans);
                            if (offer) {
                                messages.push({ role: 'assistant', content: assistantMessage });
                                setTimeout(() => {
                                    const offerMessage = formatConsolidationOffer(extractedLoans, offer);
                                    messages.push({ role: 'assistant', content: offerMessage });
                                    renderMessages();
                                }, 500);
                            } else {
                                messages.push({ role: 'assistant', content: assistantMessage });
                            }
                        } else {
                            // Check if they're providing manual loan details
                            const manualLoan = extractLoanFromText(userMessage);
                            if (manualLoan) {
                                extractedLoans.push(manualLoan);
                                // Acknowledge but don't show offer yet - wait for them to say they're done
                                const ackMsg = language === 'es'
                                    ? `¬°Perfecto! Registr√© tu pr√©stamo con ${manualLoan.lender}. Saldo: $${manualLoan.balance.toLocaleString()} MXN a ${manualLoan.rate}% ${manualLoan.rateType === 'monthly' ? 'mensual' : 'semanal'}.`
                                    : `Perfect! I recorded your loan with ${manualLoan.lender}. Balance: $${manualLoan.balance.toLocaleString()} MXN at ${manualLoan.rate}% ${manualLoan.rateType === 'monthly' ? 'monthly' : 'weekly'}.`;
                                
                                messages.push({ role: 'assistant', content: assistantMessage });
                                messages.push({ role: 'assistant', content: ackMsg });
                            } else {
                                // Regular text message, no extraction needed
                                messages.push({ role: 'assistant', content: assistantMessage });
                            }
                        }
                    } else {
                        // Regular text message, no extraction needed
                        messages.push({ role: 'assistant', content: assistantMessage });
                    }
                }
            } catch (error) {
                console.error('Error sending message:', error);
                const errorMsg = language === 'es' 
                    ? '¬°Ups, perd√≥n por eso! Tuve un peque√±o problema. ¬øPuedes intentar de nuevo?'
                    : 'Oops, sorry about that! Had a little hiccup on my end. Mind trying again?';
                messages.push({ role: 'assistant', content: errorMsg });
            }
            
            isLoading = false;
            renderMessages();
        }

        // Authentication functions
        function checkAuthentication() {
            const stored = sessionStorage.getItem('demo_authenticated');
            if (stored === 'true') {
                isAuthenticated = true;
                document.getElementById('passwordModal').classList.add('hidden');
                startConversation();
            } else {
                document.getElementById('passwordModal').classList.remove('hidden');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('usernameInput').value.trim();
            const password = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');

            if (username === DEMO_CREDENTIALS.username && password === DEMO_CREDENTIALS.password) {
                isAuthenticated = true;
                sessionStorage.setItem('demo_authenticated', 'true');
                document.getElementById('passwordModal').classList.add('hidden');
                startConversation();
            } else {
                errorDiv.textContent = 'Invalid username or password';
                errorDiv.classList.remove('hidden');
                document.getElementById('passwordInput').value = '';
            }
        }

        // Event listeners
        document.getElementById('loginForm').addEventListener('submit', handleLogin);

        elements.messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage(elements.messageInput.value);
        });

        elements.imageBtn.addEventListener('click', () => {
            elements.fileInput.click();
        });

        elements.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageData = event.target.result;
                    const defaultMsg = language === 'es' ? 'Aqu√≠ est√° mi captura del pr√©stamo' : "Here's my loan screenshot";
                    sendMessage(elements.messageInput.value || defaultMsg, imageData);
                    elements.messageInput.value = '';
                };
                reader.readAsDataURL(file);
            }
        });

        elements.resetBtn.addEventListener('click', () => {
            messages = [];
            extractedLoans = [];
            loanExtractionAttempts = 0;
            upsellOffered = false;
            upsellAccepted = false;
            startConversation();
        });

        elements.langToggle.addEventListener('click', () => {
            language = language === 'es' ? 'en' : 'es';
            messages = [];
            extractedLoans = [];
            loanExtractionAttempts = 0;
            upsellOffered = false;
            upsellAccepted = false;
            updateUIText();
            startConversation();
        });

        // API key input no longer needed

        // Initialize
        updateUIText();
        // Conversation will start automatically if API key exists (handled above)
    </script>
</body>
</html>