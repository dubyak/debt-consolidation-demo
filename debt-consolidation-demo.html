<!DOCTYPE html>
<!--
    Debt Consolidation Demo - Local Version
    ========================================
    
    This is a standalone HTML file that can run locally without build tools.
    
    SETUP:
    1. Make sure your backend server is running (see backend/README.md)
    2. Open this file in a web browser
    3. The demo will automatically connect to http://localhost:3000 if running locally
    
    REQUIREMENTS:
    - Backend server running on port 3000 (or update API_URL in the script)
    - Backend must have ANTHROPIC_API_KEY set in environment variables
    
    FEATURES:
    - Bilingual support (English/Spanish)
    - Image upload for loan screenshots
    - Editable customer profile
    - Full conversation flow with Andrea, the Tala loan advisor
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tala - Debt Consolidation Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Nunito', sans-serif;
        }
        /* Design System Colors */
        :root {
            --orange-primary: #FF6B35;
            --orange-hover: #E55A2B;
            --light-blue: #E3F2FD;
            --blue-accent: #2196F3;
            --dark-grey: #2D2D2D;
            --light-grey-bg: #F5F5F5;
        }
        .btn-primary {
            background-color: var(--orange-primary);
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .btn-primary:hover {
            background-color: var(--orange-hover);
        }
        .progress-bar {
            background-color: var(--light-blue);
            height: 4px;
            border-radius: 2px;
        }
        .progress-fill {
            background-color: var(--blue-accent);
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'orange-primary': '#FF6B35',
                        'orange-hover': '#E55A2B',
                        'light-blue': '#E3F2FD',
                        'blue-accent': '#2196F3',
                        'dark-grey': '#2D2D2D',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-4">
        <!-- Phone Frame -->
        <div class="w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden border-8 border-gray-800 relative">
            <!-- Status Bar -->
            <div class="bg-gray-800 text-white px-6 py-2 flex justify-between items-center text-xs">
                <span>9:41</span>
                <div class="flex gap-1 items-center">
                    <div class="w-4 h-2 border border-white rounded-sm relative">
                        <div class="absolute inset-0.5 bg-white rounded-sm" style="width: 80%;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Header -->
            <div class="bg-gradient-to-r from-emerald-400 to-teal-500 px-4 py-4 flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center overflow-hidden">
                    <img id="andreaImage" src="images/andrea.png" alt="Andrea" class="w-full h-full object-cover object-center rounded-full" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="text-xl" style="display:none;">üë©‚Äçüíº</span>
                </div>
                <div class="flex-1 flex items-center gap-2">
                    <div>
                        <h1 id="title" class="text-white font-semibold text-lg tracking-tight">Tala</h1>
                        <p id="subtitle" class="text-white/90 text-xs">Tu aliado financiero</p>
                    </div>
                    <img src="https://www.tala.co/wp-content/uploads/2021/06/tala-logo-white.svg" alt="Tala Logo" class="h-5 opacity-90" onerror="this.style.display='none';">
                </div>
                <div class="flex items-center gap-2">
                    <button 
                        id="langToggle"
                        class="px-3 py-1.5 bg-white/20 hover:bg-white/30 text-white text-xs font-semibold rounded-lg transition-colors"
                    >
                        EN
                    </button>
                    <button 
                        id="resetBtn"
                        class="text-white/80 hover:text-white text-xs underline"
                    >
                        Reiniciar
                    </button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messagesArea" class="h-96 overflow-y-auto p-4 space-y-3 bg-white">
                <!-- Messages will be inserted here -->
            </div>

            <!-- Input Area -->
            <div class="border-t border-gray-100 bg-white p-3">
                <form id="messageForm" class="flex gap-2 items-end">
                    <button
                        type="button"
                        id="imageBtn"
                        class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-600 transition-colors flex-shrink-0"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <input
                        type="file"
                        id="fileInput"
                        accept="image/*"
                        class="hidden"
                    />
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="Escribe un mensaje..."
                        class="flex-1 bg-gray-100 rounded-full px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[#FF6B35]/20 transition-all"
                    />
                    <button
                        type="submit"
                        id="sendBtn"
                        class="w-10 h-10 rounded-full bg-[#FF6B35] hover:bg-[#E55A2B] disabled:bg-gray-300 flex items-center justify-center text-white transition-colors flex-shrink-0"
                    >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const UI_TEXT = {
            en: {
                title: 'Andrea from Tala',
                subtitle: 'Your loan buddy',
                reset: 'Reset',
                typePlaceholder: 'Type a message...',
                langToggle: 'ES'
            },
            es: {
                title: 'Andrea de Tala',
                subtitle: 'Tu aliado financiero',
                reset: 'Reiniciar',
                typePlaceholder: 'Escribe un mensaje...',
                langToggle: 'EN'
            }
        };

        const SYSTEM_PROMPT_EN = `You are Andrea, a friendly loan advisor at Tala. You're warm, supportive, and genuinely want to help customers manage their finances better. Think of yourself as that helpful friend at a neighborhood credit cooperative - approachable, not corporate.

CONTEXT:
- The customer details will be provided (name, current Tala limit, current Tala rate, term)
- They have completed 5 loans successfully with Tala
- They have ALREADY OPTED IN to this special opportunity - they're interested and ready to proceed
- This is a debt consolidation product - ONE loan to replace all their other loans

CONSOLIDATION LOAN LOGIC:
- We offer ONE consolidation loan that pays off ALL their other loans (including any outstanding Tala balance)
- The consolidation loan limit = total of all their outstanding loans, UP TO A MAX OF $15,000 MXN
- The consolidation loan rate = WEIGHTED AVERAGE of all their loan rates (including Tala's rate)
- This means: if they have expensive loans elsewhere, consolidating brings their blended rate DOWN
- Show them the math: "Your current loans average X% interest. With consolidation, you get one simple payment at Y% - that's Z pesos saved per week!"

YOUR PERSONALITY:
- Warm and conversational, like talking to a trusted neighbor
- Use casual language, contractions, even the occasional emoji when it fits naturally
- Celebrate their good payment history genuinely
- Be empathetic about the stress of managing multiple loans
- Never sound like a bank robot or use corporate jargon
- Ask one question at a time, keep messages short and digestible
- Use their name occasionally (but not every message)

FLOW TO FOLLOW (they've already opted in, so skip the pitch):
1. GREETING: Warmly greet them, thank them for opting in, and let them know you're excited to help them simplify their finances
2. EXPLAIN PROCESS: Briefly explain what you need - screenshots of 3 loans from other apps. Keep it simple and reassuring.
3. COLLECTION: Guide them through sharing screenshots one at a time. For each screenshot they share, acknowledge it warmly and extract/confirm: lender name, outstanding balance, interest rate (weekly or monthly). IMPORTANT: Make competitor rates higher than Tala's (typically 6-12% weekly or 25-50% monthly).
4. SUMMARY & OFFER: After 3+ loans shared, present the consolidation offer:
   - List all loans: Tala + the ones they shared (lender, balance, rate)
   - Calculate TOTAL outstanding balance (cap at $15,000 MXN if higher)
   - Calculate the WEIGHTED AVERAGE rate across all loans
   - Show the consolidation offer: ONE loan for the total amount at the blended rate
   - Emphasize benefits: "Instead of juggling 4 different payments at different rates, you get ONE payment, ONE due date, and a lower blended rate of X%"
   - Calculate weekly/monthly savings in pesos
5. APPROVAL: Confirm they're approved! The consolidation loan will pay off their other loans directly. One simple payment going forward.

IMPORTANT BEHAVIORS:
- When they share an image, pretend you can see it and extract realistic loan details. Use Mexican lender names like: Kueski, Stori, Nu M√©xico, Mercado Cr√©dito, Creditea, Dineria, Konf√≠o, Credilikeme, Moneyman, or Cashclick
- CRITICAL: Competitor rates should be HIGHER than Tala's rate (from customer profile). This makes the weighted average attractive.
- Keep responses SHORT - 2-3 sentences max usually, EXCEPT for the final summary where you show the full consolidation math
- They already opted in, so don't re-pitch or ask if they're interested - they ARE
- If they seem hesitant about sharing, be reassuring about privacy/security
- ALWAYS respond in English
- Remember: max consolidation limit is $15,000 MXN even if their total debt is higher

CURRENCY: Always use Mexican pesos (MXN) with $ symbol, e.g., $5,000 MXN

Current state will be provided in each message so you know where you are in the flow.`;

        const SYSTEM_PROMPT_ES = `Eres Andrea, una asesora de pr√©stamos amigable en Tala. Eres c√°lida, comprensiva y genuinamente quieres ayudar a los clientes a manejar mejor sus finanzas. Piensa en ti misma como esa amiga servicial de una cooperativa de cr√©dito del barrio - accesible, no corporativa.

CONTEXTO:
- Los detalles del cliente se proporcionar√°n (nombre, l√≠mite actual en Tala, tasa actual en Tala, plazo)
- Han completado 5 pr√©stamos exitosamente con Tala
- YA ACEPTARON participar en esta oportunidad especial - est√°n interesados y listos para continuar
- Este es un producto de consolidaci√≥n de deudas - UN pr√©stamo para reemplazar todos sus otros pr√©stamos

L√ìGICA DEL PR√âSTAMO DE CONSOLIDACI√ìN:
- Ofrecemos UN pr√©stamo de consolidaci√≥n que paga TODOS sus otros pr√©stamos (incluyendo cualquier saldo pendiente de Tala)
- El l√≠mite del pr√©stamo de consolidaci√≥n = total de todos sus pr√©stamos pendientes, HASTA UN M√ÅXIMO DE $15,000 MXN
- La tasa del pr√©stamo de consolidaci√≥n = PROMEDIO PONDERADO de todas sus tasas de pr√©stamos (incluyendo la tasa de Tala)
- Esto significa: si tienen pr√©stamos caros en otros lados, consolidar baja su tasa combinada
- Mu√©strales las cuentas: "Tus pr√©stamos actuales promedian X% de inter√©s. Con la consolidaci√≥n, tienes un solo pago al Y% - ¬°eso son Z pesos menos por semana!"

TU PERSONALIDAD:
- C√°lida y conversacional, como hablar con un vecino de confianza
- Usa lenguaje casual, coloquial mexicano natural, y emojis ocasionales cuando encajen naturalmente
- Celebra genuinamente su buen historial de pagos
- S√© emp√°tica sobre el estr√©s de manejar m√∫ltiples pr√©stamos
- Nunca suenes como un robot bancario ni uses jerga corporativa
- Haz una pregunta a la vez, mant√©n los mensajes cortos y f√°ciles de digerir
- Usa su nombre ocasionalmente (pero no en cada mensaje)
- Usa "t√∫" no "usted" - queremos un tono cercano

FLUJO A SEGUIR (ya aceptaron participar, as√≠ que salta el pitch):
1. SALUDO: Sal√∫dalos calurosamente, agrad√©celes por aceptar, y hazles saber que est√°s emocionada de ayudarlos a simplificar sus finanzas
2. EXPLICAR PROCESO: Explica brevemente lo que necesitas - capturas de pantalla de 3 pr√©stamos de otras apps. Mantenlo simple y tranquilizador.
3. RECOLECCI√ìN: Gu√≠alos para compartir capturas una por una. Por cada captura que compartan, recon√≥cela calurosamente y extrae/confirma: nombre del prestamista, saldo pendiente, tasa de inter√©s (semanal o mensual). IMPORTANTE: Las tasas de competidores deben ser m√°s altas que la de Tala (t√≠picamente 6-12% semanal o 25-50% mensual).
4. RESUMEN Y OFERTA: Despu√©s de 3+ pr√©stamos compartidos, presenta la oferta de consolidaci√≥n:
   - Lista todos los pr√©stamos: Tala + los que compartieron (prestamista, saldo, tasa)
   - Calcula el saldo TOTAL pendiente (tope en $15,000 MXN si es mayor)
   - Calcula la tasa PROMEDIO PONDERADO de todos los pr√©stamos
   - Muestra la oferta de consolidaci√≥n: UN pr√©stamo por el monto total a la tasa combinada
   - Enfatiza los beneficios: "En vez de estar batallando con 4 pagos diferentes a diferentes tasas, tienes UN solo pago, UNA fecha de vencimiento, y una tasa combinada m√°s baja del X%"
   - Calcula el ahorro semanal/mensual en pesos
5. APROBACI√ìN: ¬°Confirma que est√°n aprobados! El pr√©stamo de consolidaci√≥n pagar√° sus otros pr√©stamos directamente. Un solo pago simple de aqu√≠ en adelante.

COMPORTAMIENTOS IMPORTANTES:
- Cuando compartan una imagen, finge que puedes verla y extrae detalles realistas del pr√©stamo. Usa nombres de prestamistas mexicanos como: Kueski, Stori, Nu M√©xico, Mercado Cr√©dito, Creditea, Dineria, Konf√≠o, Credilikeme, Moneyman, o Cashclick
- CR√çTICO: Las tasas de competidores deben ser M√ÅS ALTAS que la tasa de Tala (del perfil del cliente). Esto hace que el promedio ponderado sea atractivo.
- Mant√©n las respuestas CORTAS - 2-3 oraciones m√°ximo usualmente, EXCEPTO para el resumen final donde muestras todas las cuentas de consolidaci√≥n
- Ya aceptaron participar, as√≠ que no vuelvas a hacer pitch ni preguntes si est√°n interesados - S√ç LO EST√ÅN
- Si parecen dudosos sobre compartir, s√© tranquilizadora sobre privacidad/seguridad
- SIEMPRE responde en espa√±ol mexicano natural
- Recuerda: el l√≠mite m√°ximo de consolidaci√≥n es $15,000 MXN aunque su deuda total sea mayor

MONEDA: Siempre usa pesos mexicanos (MXN) con s√≠mbolo $, ej., $5,000 MXN

El estado actual se proporcionar√° en cada mensaje para que sepas d√≥nde est√°s en el flujo.`;

        const INITIAL_STATE = {
            stage: 'greeting',
            loansCollected: [],
            customerName: 'Mar√≠a',
            currentLimit: 3000,
            newLimit: 15000,
            currentRate: 4.5,
            currentTerm: 4,
            loansRequired: 3
        };

        // Configuration - Update this to match your backend URL
        const API_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3000'
            : 'https://debt-consolidation-demo-production.up.railway.app';

        // State management
        let messages = [];
        let flowState = { ...INITIAL_STATE };
        let uploadedImages = [];
        let language = 'es';
        let isLoading = false;
        let editForm = {
            customerName: INITIAL_STATE.customerName,
            currentLimit: INITIAL_STATE.currentLimit,
            currentRate: INITIAL_STATE.currentRate,
            currentTerm: INITIAL_STATE.currentTerm
        };

        // DOM elements
        const elements = {
            messagesArea: document.getElementById('messagesArea'),
            messageInput: document.getElementById('messageInput'),
            messageForm: document.getElementById('messageForm'),
            fileInput: document.getElementById('fileInput'),
            imageBtn: document.getElementById('imageBtn'),
            sendBtn: document.getElementById('sendBtn'),
            resetBtn: document.getElementById('resetBtn'),
            langToggle: document.getElementById('langToggle'),
            title: document.getElementById('title'),
            subtitle: document.getElementById('subtitle')
        };

        // Set Andrea's image path
        const andreaImage = document.getElementById('andreaImage');
        if (andreaImage) {
            if (API_URL && (window.location.protocol === 'http:' || window.location.protocol === 'https:')) {
                // If using backend server, use the server URL
                andreaImage.src = `${API_URL}/images/andrea.png`;
            } else {
                // For file:// protocol, use local images folder
                andreaImage.src = 'images/andrea.png';
            }
        }

        // Update UI text based on language
        function updateUIText() {
            const t = UI_TEXT[language];
            elements.title.textContent = t.title;
            elements.subtitle.textContent = t.subtitle;
            elements.resetBtn.textContent = t.reset;
            elements.messageInput.placeholder = t.typePlaceholder;
            elements.langToggle.textContent = t.langToggle;
        }

        // Render messages
        function renderMessages() {
            elements.messagesArea.innerHTML = '';
            
            messages.forEach((msg, idx) => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = `max-w-xs ${msg.role === 'user' ? 'order-2' : ''}`;
                
                if (msg.image) {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'mb-1 rounded-xl overflow-hidden border-2 border-gray-200';
                    const img = document.createElement('img');
                    img.src = msg.image;
                    img.alt = 'Uploaded loan';
                    img.className = 'w-full max-h-32 object-cover';
                    imgDiv.appendChild(img);
                    contentDiv.appendChild(imgDiv);
                }
                
                const textDiv = document.createElement('div');
                textDiv.className = `px-4 py-2.5 rounded-2xl text-sm leading-relaxed ${
                    msg.role === 'user' 
                        ? 'bg-[#FF6B35] text-white rounded-br-md shadow-sm' 
                        : 'bg-white text-gray-700 rounded-bl-md shadow-sm border border-gray-200'
                }`;
                textDiv.textContent = msg.content;
                contentDiv.appendChild(textDiv);
                
                msgDiv.appendChild(contentDiv);
                elements.messagesArea.appendChild(msgDiv);
            });
            
            if (isLoading) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex justify-start';
                loadingDiv.innerHTML = `
                    <div class="bg-white px-4 py-3 rounded-2xl rounded-bl-md shadow-sm border border-gray-200">
                        <div class="flex gap-1">
                            <div class="w-2 h-2 bg-[#FF6B35] rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
                            <div class="w-2 h-2 bg-[#FF6B35] rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
                            <div class="w-2 h-2 bg-[#FF6B35] rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
                        </div>
                    </div>
                `;
                elements.messagesArea.appendChild(loadingDiv);
            }
            
            elements.messagesArea.scrollTop = elements.messagesArea.scrollHeight;
        }

        // Start conversation
        async function startConversationWithState(lang, state) {
            const prompt = lang === 'es' ? SYSTEM_PROMPT_ES : SYSTEM_PROMPT_EN;
            const customerInfo = lang === 'es'
                ? `Nombre: ${state.customerName}, L√≠mite actual: $${state.currentLimit.toLocaleString()} MXN, Tasa: ${state.currentRate}%, Plazo: ${state.currentTerm} semanas, Nuevo l√≠mite ofrecido: $${state.newLimit.toLocaleString()} MXN`
                : `Name: ${state.customerName}, Current limit: $${state.currentLimit.toLocaleString()} MXN, Rate: ${state.currentRate}%, Term: ${state.currentTerm} weeks, New limit offered: $${state.newLimit.toLocaleString()} MXN`;
            
            const langInstruction = lang === 'es' 
                ? `[SISTEMA: Inicia la conversaci√≥n. Datos del cliente: ${customerInfo}. Esta es la etapa de saludo. Ya aceptaron participar en la oportunidad de consolidaci√≥n. ¬°S√© c√°lida y personal! Responde en espa√±ol.]`
                : `[SYSTEM: Start the conversation. Customer details: ${customerInfo}. This is the greeting stage. They have already opted in to the consolidation opportunity. Be warm and personal! Respond in English.]`;
            
            isLoading = true;
            renderMessages();
            
            const fallback = lang === 'es' 
                ? `¬°Hola ${state.customerName}! üëã Qu√© gusto que aceptaste esta oportunidad. Soy Andrea de Tala, y estoy aqu√≠ para ayudarte a desbloquear tu nuevo l√≠mite de $${state.newLimit.toLocaleString()} MXN. Solo necesitamos revisar algunos pr√©stamos que tengas con otras apps. ¬øLista para empezar?`
                : `Hey ${state.customerName}! üëã So glad you opted in for this opportunity. I'm Andrea from Tala, and I'm here to help you unlock your new $${state.newLimit.toLocaleString()} MXN limit. We just need to review a few loans you have with other apps. Ready to get started?`;
            
            try {
                const response = await fetch(`${API_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 500,
                        system: prompt,
                        messages: [{
                            role: 'user',
                            content: langInstruction
                        }],
                        sessionId: `debt-consolidation-${Date.now()}`,
                        userId: state.customerName
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                
                const data = await response.json();
                // Handle both direct API response and backend proxy response formats
                const assistantMessage = data.content?.[0]?.text || data.content?.[0]?.content || data.content || fallback;
                messages = [{ role: 'assistant', content: assistantMessage }];
            } catch (error) {
                console.error('Error starting conversation:', error);
                messages = [{ role: 'assistant', content: fallback }];
            }
            isLoading = false;
            renderMessages();
        }

        // Send message
        async function sendMessage(userMessage, imageData = null) {
            if (!userMessage.trim() && !imageData) return;

            const newUserMessage = { 
                role: 'user', 
                content: userMessage,
                image: imageData 
            };
            
            messages.push(newUserMessage);
            elements.messageInput.value = '';
            isLoading = true;
            renderMessages();

            const systemPrompt = language === 'es' ? SYSTEM_PROMPT_ES : SYSTEM_PROMPT_EN;
            const langNote = language === 'es' ? 'RESPONDE EN ESPA√ëOL.' : 'RESPOND IN ENGLISH.';

            const apiMessages = messages.map((msg, idx) => {
                if (msg.role === 'user') {
                    let content = msg.content;
                    
                    if (msg.image) {
                        const imageInstruction = language === 'es'
                            ? `[USUARIO COMPARTI√ì UNA CAPTURA DE UN PR√âSTAMO]\n\nSu mensaje: "${msg.content || '(sin texto, solo la imagen)'}"\n\n[SISTEMA: Finge que puedes ver la captura del pr√©stamo. Inventa detalles realistas - usa un nombre de prestamista mexicano como Kueski, Stori, Nu M√©xico, Mercado Cr√©dito, Creditea, Dineria, Konf√≠o, Credilikeme, Moneyman, o Cashclick. Genera monto plausible ($1,000-$8,000 MXN), fecha de vencimiento (pr√≥ximos 30 d√≠as), y saldo restante. Reconoce calurosamente y confirma los detalles. Pr√©stamos recolectados hasta ahora: ${flowState.loansCollected.length}. Necesita ${flowState.loansRequired - flowState.loansCollected.length} m√°s. ${langNote}]`
                            : `[USER SHARED A SCREENSHOT OF A LOAN]\n\nTheir message: "${msg.content || '(no text, just the image)'}"\n\n[SYSTEM: Pretend you can see the loan screenshot. Make up realistic details - pick a Mexican lender name like Kueski, Stori, Nu M√©xico, Mercado Cr√©dito, Creditea, Dineria, Konf√≠o, Credilikeme, Moneyman, or Cashclick. Generate plausible loan amount ($1,000-$8,000 MXN), due date (within next 30 days), and remaining balance. Acknowledge warmly and confirm the details with them. Loans collected so far: ${flowState.loansCollected.length}. Need ${flowState.loansRequired - flowState.loansCollected.length} more. ${langNote}]`;
                        content = imageInstruction;
                    }
                    
                    if (idx === messages.length - 1) {
                        content += `\n\n[CURRENT STATE: Stage=${flowState.stage}, Loans collected=${flowState.loansCollected.length}/${flowState.loansRequired}. ${langNote}]`;
                    }
                    
                    return { role: 'user', content };
                }
                return { role: 'assistant', content: msg.content };
            });

            try {
                const response = await fetch(`${API_URL}/api/chat`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        max_tokens: 500,
                        system: systemPrompt,
                        messages: apiMessages,
                        sessionId: `debt-consolidation-${Date.now()}`,
                        userId: flowState.customerName
                    })
                });
                
                const data = await response.json();
                // Handle both direct API response and backend proxy response formats
                const assistantMessage = data.content?.[0]?.text || data.content?.[0]?.content || data.content || 'Error: Invalid response format';
                
                let newState = { ...flowState };
                if (imageData) {
                    newState.loansCollected = [...flowState.loansCollected, { id: Date.now() }];
                    if (newState.loansCollected.length >= flowState.loansRequired) {
                        newState.stage = 'confirming';
                    } else {
                        newState.stage = 'collecting';
                    }
                } else if (flowState.stage === 'greeting') {
                    newState.stage = 'explaining';
                }
                flowState = newState;
                
                messages.push({ role: 'assistant', content: assistantMessage });
            } catch (error) {
                console.error('Error sending message:', error);
                const errorMsg = language === 'es' 
                    ? "¬°Ups, perd√≥n por eso! Tuve un peque√±o problema. ¬øPuedes intentar de nuevo?"
                    : "Oops, sorry about that! Had a little hiccup on my end. Mind trying again?";
                messages.push({ role: 'assistant', content: errorMsg });
            }
            
            isLoading = false;
            renderMessages();
        }

        // Event listeners
        elements.messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sendMessage(elements.messageInput.value);
        });

        elements.imageBtn.addEventListener('click', () => {
            elements.fileInput.click();
        });

        elements.fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const imageData = event.target.result;
                    uploadedImages.push(imageData);
                    const defaultMsg = language === 'es' ? 'Aqu√≠ est√° mi captura del pr√©stamo' : "Here's my loan screenshot";
                    sendMessage(elements.messageInput.value || defaultMsg, imageData);
                    elements.messageInput.value = '';
                };
                reader.readAsDataURL(file);
            }
        });

        elements.resetBtn.addEventListener('click', () => {
            messages = [];
            uploadedImages = [];
            setTimeout(() => startConversationWithState(language, flowState), 100);
        });

        elements.langToggle.addEventListener('click', () => {
            language = language === 'es' ? 'en' : 'es';
            messages = [];
            uploadedImages = [];
            updateUIText();
            setTimeout(() => {
                startConversationWithState(language, flowState);
            }, 100);
        });


        // Initialize
        updateUIText();
        startConversationWithState(language, flowState);
    </script>
</body>
</html>
